<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>20&nbsp; SHAP Results – The Imaginary Healthy Patient</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./robustness-shap-estimations-sah.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.33/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {
	     MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';
		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';
		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';
		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';
		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';
		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';
		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';
		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';
		 
		 
		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';
		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';
		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';
		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';
		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';
	});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">The Imaginary Healthy Patient</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/3wen/imaginary-healthy"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./robustness-data-cleaning-sah.html">V Robustness Checks: SAH</a></li><li class="breadcrumb-item"><a href="./robustness-shap-results-sah.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">SHAP Results</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">I Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-load_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Load Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Cleaning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-sunlight.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sunlight Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-descriptive_statistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Descriptive Statistics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">II Classifiers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./classif-estimations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Estimations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./classif-results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Results</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">III SHAP</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./shap-estimations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Estimations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./shap-results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Results</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">IV Robustness Checks: MHI-3</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-data-cleaning-mhi3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Data Cleaning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-descriptive_statistics-mhi3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Descriptive Statistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-classif-estimations-mhi3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Classification Estimations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-classif-results-mhi3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Classification Results</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-shap-estimations-mhi3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">SHAP Estimations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-shap-results-mhi3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">SHAP Results</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">V Robustness Checks: SAH</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-data-cleaning-sah.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Data Cleaning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-descriptive_statistics-sah.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Descriptive Statistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-classif-estimations-sah.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Estimations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-classif-results-sah.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Results</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-shap-estimations-sah.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robustness-shap-results-sah.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">SHAP Results</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#load-data-and-estimated-models" id="toc-load-data-and-estimated-models" class="nav-link active" data-scroll-target="#load-data-and-estimated-models"><span class="header-section-number">20.1</span> Load data and estimated models</a>
  <ul class="collapse">
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">20.1.1</span> Data</a></li>
  <li><a href="#classifiers" id="toc-classifiers" class="nav-link" data-scroll-target="#classifiers"><span class="header-section-number">20.1.2</span> Classifiers</a></li>
  <li><a href="#shap-values" id="toc-shap-values" class="nav-link" data-scroll-target="#shap-values"><span class="header-section-number">20.1.3</span> SHAP Values</a></li>
  </ul></li>
  <li><a href="#predicted-values-classifier" id="toc-predicted-values-classifier" class="nav-link" data-scroll-target="#predicted-values-classifier"><span class="header-section-number">20.2</span> Predicted Values (classifier)</a>
  <ul class="collapse">
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest"><span class="header-section-number">20.2.1</span> Random Forest</a></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost"><span class="header-section-number">20.2.2</span> XGBoost</a></li>
  </ul></li>
  <li><a href="#understanding-the-output" id="toc-understanding-the-output" class="nav-link" data-scroll-target="#understanding-the-output"><span class="header-section-number">20.3</span> Understanding the Output</a></li>
  <li><a href="#variable-importance" id="toc-variable-importance" class="nav-link" data-scroll-target="#variable-importance"><span class="header-section-number">20.4</span> Variable importance</a></li>
  <li><a href="#clustering" id="toc-clustering" class="nav-link" data-scroll-target="#clustering"><span class="header-section-number">20.5</span> Clustering</a>
  <ul class="collapse">
  <li><a href="#note" id="toc-note" class="nav-link" data-scroll-target="#note"><span class="header-section-number">20.5.1</span> Note</a></li>
  <li><a href="#descriptive-statistics-of-the-clusters" id="toc-descriptive-statistics-of-the-clusters" class="nav-link" data-scroll-target="#descriptive-statistics-of-the-clusters"><span class="header-section-number">20.5.2</span> Descriptive Statistics of the Clusters</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./robustness-data-cleaning-sah.html">V Robustness Checks: SAH</a></li><li class="breadcrumb-item"><a href="./robustness-shap-results-sah.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">SHAP Results</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-shap-values-results-sah" class="quarto-section-identifier"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">SHAP Results</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chapter presents the results from <a href="robustness-shap-estimations-sah.html" class="quarto-xref">Chapter&nbsp;<span>19</span></a>.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice

Attaching package: 'caret'

The following object is masked from 'package:purrr':

    lift</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(treeshap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us define a theme for graphs.</p>
<div class="cell">
<details class="code-fold">
<summary>Definition of <code class="sourceCode r"><span class="fu">theme_paper</span>()</code></summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Theme for ggplot2</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ... arguments passed to the theme function</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom ggplot2 element_rect element_text element_blank element_line unit</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'   rel</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>theme_paper <span class="ot">&lt;-</span> <span class="cf">function</span> (...) {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  ggthemes<span class="sc">::</span><span class="fu">theme_base</span>() <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.background =</span> <span class="fu">element_rect</span>(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"transparent"</span>, <span class="at">linetype=</span><span class="st">"solid"</span>, <span class="at">colour =</span><span class="st">"black"</span>),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.box =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key =</span> <span class="fu">element_blank</span>()</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="load-data-and-estimated-models" class="level2" data-number="20.1">
<h2 data-number="20.1" class="anchored" data-anchor-id="load-data-and-estimated-models"><span class="header-section-number">20.1</span> Load data and estimated models</h2>
<section id="data" class="level3" data-number="20.1.1">
<h3 data-number="20.1.1" class="anchored" data-anchor-id="data"><span class="header-section-number">20.1.1</span> Data</h3>
<p>Let us load the train and test data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/out/df_train_sah.rda"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/out/df_test_sah.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For random forests, we need to convert categorical variables to numerical variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df_train_num <span class="ot">&lt;-</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  df_train <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.factor), as.numeric))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>df_test_num <span class="ot">&lt;-</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  df_test <span class="sc">|&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.factor), as.numeric))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We keep track of the levels of factor data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>corresp_factors <span class="ot">&lt;-</span> df_train <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_if</span>(is.factor) <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(levels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="classifiers" class="level3" data-number="20.1.2">
<h3 data-number="20.1.2" class="anchored" data-anchor-id="classifiers"><span class="header-section-number">20.1.2</span> Classifiers</h3>
<p>The estimated models (see <span class="quarto-unresolved-ref">?sec-estimations-mhi</span>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The estimated random forests (and the grid)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/out/estim/v3/grid_search_rf_sah.rda"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The estimated xgb (and the grid)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/out/estim/v3/grid_search_xgb_sah.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us get the best classifiers obtained both for the random forest and XGBoost. Let us begin with random forests:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ind_remove <span class="ot">&lt;-</span> <span class="fu">which</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df_train) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"status"</span>, <span class="st">"id"</span>, <span class="st">"PERSONNE_statut"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="st">"status ~"</span>, <span class="fu">paste</span>(<span class="fu">colnames</span>(df_train[<span class="sc">-</span>ind_remove]), <span class="at">collapse =</span> <span class="st">"+"</span>))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>final_model_rf <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  formula,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_train_num, </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> grid_search_rf<span class="sc">$</span>bestTune<span class="sc">$</span>mtry,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">splitrule =</span> <span class="st">"gini"</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.node.size =</span> grid_search_rf<span class="sc">$</span>bestTune<span class="sc">$</span>min.node.size,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">classification =</span> T</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And for the extreme gradient boosting algorithm:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>final_model_xgb <span class="ot">&lt;-</span> grid_search_xgb<span class="sc">$</span>finalModel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="shap-values" class="level3" data-number="20.1.3">
<h3 data-number="20.1.3" class="anchored" data-anchor-id="shap-values"><span class="header-section-number">20.1.3</span> SHAP Values</h3>
<p>We load the results estimated SHAP values (see <a href="robustness-shap-estimations-sah.html" class="quarto-xref">Chapter&nbsp;<span>19</span></a>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/out/treeSHAP/v3/treeshap_rf_sah.rda"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/out/treeSHAP/v3/treeshap_xgb_sah.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The explainer used only the values from the train set to estimate the SHAP values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>reference_data_rf <span class="ot">&lt;-</span> df_train_num</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>reference_data_xgb <span class="ot">&lt;-</span> df_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the SHAP values were estimated on both the train set and the test set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_all_rf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_train_num, df_test_num)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df_all_xgb <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_train, df_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="predicted-values-classifier" class="level2" data-number="20.2">
<h2 data-number="20.2" class="anchored" data-anchor-id="predicted-values-classifier"><span class="header-section-number">20.2</span> Predicted Values (classifier)</h2>
<p>Let us get the predicted values for both classifiers.</p>
<section id="random-forest" class="level3" data-number="20.2.1">
<h3 data-number="20.2.1" class="anchored" data-anchor-id="random-forest"><span class="header-section-number">20.2.1</span> Random Forest</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pred_val_ref_rf <span class="ot">&lt;-</span> <span class="fu">predict</span>(final_model_rf, reference_data_rf)<span class="sc">$</span>predictions</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pred_val_ref_rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 1 1 1 1 1</code></pre>
</div>
</div>
<p>The issue is that this gives the majority vote, and not the associated scores. Let us compute the scores by aggregating the votes on each tree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the scores instead:</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>predict_score_ranger <span class="ot">&lt;-</span> <span class="cf">function</span>(object, data) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  pred_all <span class="ot">&lt;-</span> <span class="fu">predict</span>(object, data, <span class="at">predict.all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  pred_all_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pred_all<span class="sc">$</span>predictions)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  ntrees <span class="ot">&lt;-</span> <span class="fu">ncol</span>(pred_all_df)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  pred_all_df<span class="sc">$</span>votes <span class="ot">&lt;-</span> <span class="fu">rowSums</span>( pred_all_df <span class="sc">==</span> <span class="dv">1</span> ) <span class="sc">/</span> ntrees</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  pred_all_df<span class="sc">$</span>votes</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>pred_val_rf <span class="ot">&lt;-</span> <span class="fu">predict_score_ranger</span>(final_model_rf, reference_data_rf)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pred_val_rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.406 0.788 0.786 0.854 0.826 0.866</code></pre>
</div>
</div>
</section>
<section id="xgboost" class="level3" data-number="20.2.2">
<h3 data-number="20.2.2" class="anchored" data-anchor-id="xgboost"><span class="header-section-number">20.2.2</span> XGBoost</h3>
<p>And now, for XGBoost:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pred_val_xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  grid_search_xgb, <span class="at">newdata =</span> reference_data_xgb,<span class="at">type =</span> <span class="st">"prob"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>pred_val_xgb <span class="ot">&lt;-</span> pred_val_xgb[, <span class="st">"Not_D_and_inf_Q1"</span>]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pred_val_xgb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4140283 0.4672670 0.3959899 0.4698538 0.6405708 0.4444454</code></pre>
</div>
</div>
<p>Let us get the predicted values on both the train set and the test set as well:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pred_val_all_xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  grid_search_xgb, <span class="at">newdata =</span> df_all_xgb, <span class="at">type =</span> <span class="st">"prob"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>pred_val_all_xgb <span class="ot">&lt;-</span> pred_val_all_xgb[, <span class="st">"Not_D_and_inf_Q1"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="understanding-the-output" class="level2" data-number="20.3">
<h2 data-number="20.3" class="anchored" data-anchor-id="understanding-the-output"><span class="header-section-number">20.3</span> Understanding the Output</h2>
<p>Let us have a look at the first individual to explain the results obtained in the table. Let us have a look at the first individual.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>id_indiv <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>df_all_rf[id_indiv, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  PERSONNE_pb_asthm PERSONNE_pb_bronchit PERSONNE_pb_infarctus
1                 3                    3                     3
  PERSONNE_pb_coronair PERSONNE_pb_hypertens PERSONNE_pb_avc
1                    3                     3               3
  PERSONNE_pb_arthros PERSONNE_pb_lombalgi PERSONNE_pb_cervical
1                   3                    3                    3
  PERSONNE_pb_diabet PERSONNE_pb_allergi PERSONNE_pb_cirrhos
1                  3                   3                   3
  PERSONNE_pb_urinair PERSONNE_age PERSONNE_sexe PERSONNE_couple
1                   3           65             1               3
  PERSONNE_statut PERSONNE_ss PERSONNE_regime PERSONNE_rap_pcs8 PERSONNE_ald
1               2           1               1                 3            2
  SOINS_ald_am MENAGE_revucinsee MENAGE_tu MENAGE_nbpers ensol_2011
1            2              1400         1             2   2280.443
  MUTUELLE_assu MUTUELLE_typcc SOINS_remomn SOINS_remspe SOINS_rempha
1             2              2         75.5       265.14        84.05
  SOINS_remkin SOINS_reminf SOINS_remden SOINS_remmat SOINS_remtra SOINS_remopt
1       346.02         5.18       127.89            0            0            0
  SOINS_rempro SOINS_remurg SOINS_tmomn SOINS_tmspe SOINS_tmpha SOINS_tmkin
1            0            0        34.5      117.92       90.77      243.63
  SOINS_tminf SOINS_tmden SOINS_tmmat SOINS_tmtra SOINS_tmopt SOINS_tmpro
1        3.78       54.82           0           0           0           0
  SOINS_tmurg SOINS_dpaomn SOINS_dpaspe SOINS_dpapha SOINS_dpakin SOINS_dpainf
1           0            0           34            0            0            0
  SOINS_dpaden SOINS_dpamat SOINS_dpatra SOINS_dpaopt SOINS_dpapro SOINS_dpaurg
1        282.5            0            0            0            0            0
  SOINS_pf_fromn SOINS_pf_frspe SOINS_pf_frpha SOINS_pf_frkin SOINS_pf_frinf
1              5             10             17           19.5            0.5
  SOINS_pf_frden SOINS_pf_frtra SOINS_pf_frurg SOINS_seac_omn SOINS_seac_spe
1              0              0              0              5             10
  OPINION1_renonc_cons OPINION1_renonc_dent OPINION1_renonc_fin
1                    2                    2                   2
  OPINION1_renonc_loin OPINION1_renonc_long QST_ct_depech QST_ct_liberte
1                    2                    2             5              5
  QST_ct_apprend QST_ct_aidecol QST_ct_travnuit QST_ct_repet QST_ct_lourd
1              5              6               5            5            5
  QST_ct_posture QST_ct_produit QES_association QES_tpsami QES_tpsasso
1              5              5               1          1           3
  QES_tpscolleg QES_tpsfamil QES_mere_etude QES_pere_etude id status
1             6            3              5              5  1      1</code></pre>
</div>
</div>
<p>The estimated SHAP values for this individual (with the random forest):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>treeshap_rf<span class="sc">$</span>shaps[id_indiv, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  PERSONNE_pb_asthm PERSONNE_pb_bronchit PERSONNE_pb_infarctus
1      -0.007246341          -0.01336903          -0.004644532
  PERSONNE_pb_coronair PERSONNE_pb_hypertens PERSONNE_pb_avc
1         -0.006694261          -0.001778938    -0.003898941
  PERSONNE_pb_arthros PERSONNE_pb_lombalgi PERSONNE_pb_cervical
1        -0.001554188          -0.02055935          -0.05266636
  PERSONNE_pb_diabet PERSONNE_pb_allergi PERSONNE_pb_cirrhos
1       -0.008534858          -0.0259766        -0.005046734
  PERSONNE_pb_urinair PERSONNE_age PERSONNE_sexe PERSONNE_couple  PERSONNE_ss
1         -0.01245911  0.009956432   -0.02699848     0.003119755 0.0003633826
  PERSONNE_regime PERSONNE_rap_pcs8 PERSONNE_ald  SOINS_ald_am
1    -0.003175054       0.006178235 0.0003112731 -0.0002916731
  MENAGE_revucinsee   MENAGE_tu MENAGE_nbpers   ensol_2011 MUTUELLE_assu
1       0.002390928 0.001722672  0.0003568199 -0.002993251   0.000580098
  MUTUELLE_typcc SOINS_remomn SOINS_remspe SOINS_rempha SOINS_remkin
1   0.0005672605 -0.001176905  -0.01859792  0.001755285  -0.02594093
  SOINS_reminf SOINS_remden SOINS_remmat SOINS_remtra SOINS_remopt SOINS_rempro
1 -5.64542e-05 -0.003214886 2.276637e-05   0.00114703 0.0001741754 -0.001419339
  SOINS_remurg SOINS_tmomn SOINS_tmspe SOINS_tmpha SOINS_tmkin  SOINS_tminf
1  0.000990654 -0.01598007 -0.02313433 -0.01579783 -0.03061514 0.0006350854
   SOINS_tmden SOINS_tmmat  SOINS_tmtra   SOINS_tmopt   SOINS_tmpro
1 -0.004696977 0.000677272 0.0005885813 -0.0008278269 -0.0002139524
   SOINS_tmurg SOINS_dpaomn SOINS_dpaspe SOINS_dpapha SOINS_dpakin SOINS_dpainf
1 0.0008722014 0.0008331505  0.001751509 4.664878e-05 7.918558e-05  3.15962e-05
   SOINS_dpaden SOINS_dpamat SOINS_dpatra  SOINS_dpaopt SOINS_dpapro
1 -0.0008823053 0.0004741555 2.530444e-05 -0.0002633437  0.001130082
  SOINS_dpaurg SOINS_pf_fromn SOINS_pf_frspe SOINS_pf_frpha SOINS_pf_frkin
1 9.816743e-06    0.001152235   -0.007856489    -0.01523178    -0.02256475
  SOINS_pf_frinf SOINS_pf_frden SOINS_pf_frtra SOINS_pf_frurg SOINS_seac_omn
1   0.0004703884   4.160579e-05    0.000287363   0.0004107725  -0.0005260417
  SOINS_seac_spe OPINION1_renonc_cons OPINION1_renonc_dent OPINION1_renonc_fin
1    -0.02025151          0.002553635          0.005560955         0.001479719
  OPINION1_renonc_loin OPINION1_renonc_long QST_ct_depech QST_ct_liberte
1          0.001318324          0.002934469   0.005777593    0.002055691
  QST_ct_apprend QST_ct_aidecol QST_ct_travnuit QST_ct_repet QST_ct_lourd
1   -0.001787547   -0.001737267    -0.000171069  0.001085351   0.00145683
  QST_ct_posture QST_ct_produit QES_association QES_tpsami QES_tpsasso
1  -0.0001175104   0.0005289548      0.00180956 0.01116717 0.002723404
  QES_tpscolleg QES_tpsfamil QES_mere_etude QES_pere_etude
1   0.001195995 0.0005406768   -0.004747627   -0.006676365</code></pre>
</div>
</div>
<p>Each column gives the SHAP value for a variable, for this individual. Each row of <code>treeshap_rf</code> gives the SHAP values for a single individual.</p>
<p>In the reference data (we used the train set), the average predicted scores is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(mean_pred_rf_ref <span class="ot">&lt;-</span> <span class="fu">mean</span>(pred_val_rf)) <span class="co"># random forest</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7470318</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(mean_pred_xgb_ref <span class="ot">&lt;-</span> <span class="fu">mean</span>(pred_val_xgb)) <span class="co"># XGBoost</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4750502</code></pre>
</div>
</div>
<p>For the first individual, the predicted score, for the random, is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>pred_indiv_rf <span class="ot">&lt;-</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict_score_ranger</span>(final_model_rf, df_all_rf[id_indiv, ])</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>pred_indiv_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.406</code></pre>
</div>
</div>
<p>And with XGB:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>pred_indiv_xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(grid_search_xgb, df_all_xgb[id_indiv, ], <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>pred_indiv_xgb <span class="ot">&lt;-</span> pred_indiv_xgb[, <span class="st">"Not_D_and_inf_Q1"</span>]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>pred_indiv_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4140283</code></pre>
</div>
</div>
<p>For the record, the actual class is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_all_rf[id_indiv, <span class="st">"status"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>df_all_xgb[id_indiv, <span class="st">"status"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] Not_D_and_inf_Q1
Levels: Not_D_and_inf_Q1 Not_D_and_sup_Q1</code></pre>
</div>
</div>
<p>The sum of the SHAP values correspond to the deviation from the average of the scores estimated on the reference data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>shap_indiv_rf <span class="ot">&lt;-</span> treeshap_rf<span class="sc">$</span>shaps[id_indiv, ] <span class="co"># random forest</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>shap_indiv_xgb <span class="ot">&lt;-</span> treeshap_xgb<span class="sc">$</span>shaps[id_indiv, ] <span class="co"># XGBoost</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the random forest:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"shap"</span> <span class="ot">=</span> <span class="fu">sum</span>(shap_indiv_rf), </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pred"</span> <span class="ot">=</span> pred_indiv_rf, </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mean_pred"</span> <span class="ot">=</span> mean_pred_rf_ref,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"diff"</span> <span class="ot">=</span> pred_indiv_rf <span class="sc">-</span> mean_pred_rf_ref</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      shap       pred  mean_pred       diff 
-0.3410318  0.4060000  0.7470318 -0.3410318 </code></pre>
</div>
</div>
<p>and for XGBoost:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"shap"</span> <span class="ot">=</span> <span class="fu">sum</span>(shap_indiv_xgb), </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pred"</span> <span class="ot">=</span> pred_indiv_xgb, </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mean_pred"</span> <span class="ot">=</span> mean_pred_xgb_ref,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"diff"</span> <span class="ot">=</span> pred_indiv_xgb <span class="sc">-</span> mean_pred_xgb_ref</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       shap        pred   mean_pred        diff 
-0.34732477  0.41402832  0.47505017 -0.06102186 </code></pre>
</div>
</div>
<p>Let us now visualize the SHAP values for a specific individual.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/out/variable_names.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We build a table with variable names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>variable_names_categ <span class="ot">&lt;-</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(corresp_factors) <span class="sc">|&gt;</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(value) <span class="sc">|&gt;</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">str_c</span>(name, value),</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">label_categ =</span> <span class="fu">str_c</span>(label, <span class="st">" = "</span>, value)) <span class="sc">|&gt;</span> </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, label_categ, <span class="at">variable_raw =</span> name, <span class="at">variable_label_val =</span> value)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>variable_names_categ</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 189 × 4
   variable                       label_categ    variable_raw variable_label_val
   &lt;chr&gt;                          &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;             
 1 PERSONNE_pb_asthmNo            Asthma = No    PERSONNE_pb… No                
 2 PERSONNE_pb_asthmYes           Asthma = Yes   PERSONNE_pb… Yes               
 3 PERSONNE_pb_asthmNo answer     Asthma = No a… PERSONNE_pb… No answer         
 4 PERSONNE_pb_bronchitNo         Bronchitis = … PERSONNE_pb… No                
 5 PERSONNE_pb_bronchitYes        Bronchitis = … PERSONNE_pb… Yes               
 6 PERSONNE_pb_bronchitNo answer  Bronchitis = … PERSONNE_pb… No answer         
 7 PERSONNE_pb_infarctusNo        Heart Attack … PERSONNE_pb… No                
 8 PERSONNE_pb_infarctusYes       Heart Attack … PERSONNE_pb… Yes               
 9 PERSONNE_pb_infarctusNo answer Heart Attack … PERSONNE_pb… No answer         
10 PERSONNE_pb_coronairNo         Artery Diseas… PERSONNE_pb… No                
# ℹ 179 more rows</code></pre>
</div>
</div>
<p>We define a function, <code class="sourceCode r"><span class="fu">plot_individual_variable_effect</span>()</code> to understand why, according to the estimated SHAP values, the predicted value for a single individuals deviates from the average prediction in the reference sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot the decomposition of the deviation from the average prediction</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' for an individual, using SHAP values</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i row number to designate individual</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param treeshap_res result obtained with treeshap</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predicted_val_i predicted value for the individual</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mean_pred_ref average predicted value in the reference data</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n top n variables (default to 10)</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param min_max if not `NULL`, limits for the x axis (Shap values), in a </span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'  vector of length 2 containing c(min, max)</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>plot_individual_variable_effect <span class="ot">&lt;-</span> <span class="cf">function</span>(i, </span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>                                            treeshap_res, </span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>                                            predicted_val_i,</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>                                            mean_pred_ref,</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">n =</span> <span class="dv">10</span>,</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">min_max =</span> <span class="cn">NULL</span>) {</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="ot">&lt;-</span> </span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    treeshap_res<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>() <span class="sc">|&gt;</span> </span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"variable"</span>, <span class="at">value =</span> <span class="st">"shap"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(variable_names_categ, <span class="at">by =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label), label_categ, label)) <span class="sc">|&gt;</span> </span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(shap))) <span class="sc">|&gt;</span> </span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">in_top_n =</span> <span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="sc">!!</span>n) <span class="sc">|&gt;</span> </span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">label_2 =</span> <span class="fu">ifelse</span>(in_top_n, label, <span class="st">"Other Variables"</span>)</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(label_2) <span class="sc">|&gt;</span> </span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">shap =</span> <span class="fu">sum</span>(shap),</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">label_2 =</span> <span class="fu">fct_reorder</span>(label_2, <span class="fu">abs</span>(shap)),</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">label_2 =</span> <span class="fu">fct_relevel</span>(label_2, <span class="st">"Other Variables"</span>)</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_pred_ref =</span> <span class="sc">!!</span>mean_pred_ref,</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">shap_rounded =</span> <span class="fu">str_c</span>(<span class="st">"  "</span>, <span class="fu">round</span>(shap, <span class="dv">3</span>)),</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">sign =</span> <span class="fu">sign</span>(shap),</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">sign =</span> <span class="fu">factor</span>(sign, <span class="at">levels =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-"</span>, <span class="st">"+"</span>))</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_plot, </span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span>  mean_pred_ref <span class="sc">+</span> <span class="fu">pmax</span>(shap, <span class="dv">0</span>),</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> label_2,</span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> mean_pred_ref,</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymax =</span> mean_pred_ref <span class="sc">+</span> shap,</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> sign)</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_linerange</span>(<span class="at">linewidth =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> mean_pred_ref) <span class="sc">+</span></span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> shap_rounded, <span class="at">hjust =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(</span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Variable impact"</span>, </span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"-"</span> <span class="ot">=</span> <span class="st">"#EE324E"</span>, <span class="st">"+"</span> <span class="ot">=</span> <span class="st">"#009D57"</span>), </span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-"</span> <span class="ot">=</span> <span class="st">"Negative"</span>, <span class="st">"+"</span> <span class="ot">=</span> <span class="st">"Positive"</span>)</span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="cn">NULL</span>, </span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Shap values"</span>, </span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">title=</span><span class="fu">str_c</span>(<span class="st">"Predicted value: "</span>, <span class="fu">round</span>(predicted_val_i, <span class="dv">3</span>)),</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">str_c</span>(<span class="st">"Base value: "</span>, <span class="fu">round</span>(mean_pred_ref, <span class="dv">3</span>))</span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.3</span>), <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(min_max)) {</span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> min_max)</span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a>  p</span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us look at the first individual:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>treeshap_rf_opposite <span class="ot">&lt;-</span> treeshap_rf</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>treeshap_rf_opposite<span class="sc">$</span>shaps <span class="ot">&lt;-</span> <span class="sc">-</span>treeshap_rf_opposite<span class="sc">$</span>shaps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Random Forest</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">XGBoost</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_individual_variable_effect</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> i, </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">treeshap_res =</span> treeshap_rf, </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">predicted_val_i =</span> <span class="dv">1</span><span class="sc">-</span>pred_val_rf[i], </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_pred_ref =</span> <span class="dv">1</span><span class="sc">-</span>mean_pred_rf_ref, <span class="at">n =</span> <span class="dv">20</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-indiv-shap-rf-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-indiv-shap-rf-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.1: SHAP values for the first individual, when the score is estimated with a Random Forest. Positive class: Imaginary healthy patient.
</figcaption>
<div aria-describedby="fig-indiv-shap-rf-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-indiv-shap-rf-1-1.png" class="img-fluid figure-img" width="576">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_individual_variable_effect</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> i, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">treeshap_res =</span> treeshap_xgb, </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">predicted_val_i =</span> pred_val_xgb[i], </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_pred_ref =</span> mean_pred_xgb_ref, <span class="at">n =</span> <span class="dv">20</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-indiv-shap-xgb-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-indiv-shap-xgb-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.2: SHAP values for the first individual, when the score is estimated with XGBoost. Positive class: Imaginary healthy patient.
</figcaption>
<div aria-describedby="fig-indiv-shap-xgb-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-indiv-shap-xgb-1-1.png" class="img-fluid figure-img" width="576">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Now, let us pick two individuals: one with a low predicted score, and another one with a high predicted score. We define two functions: <code class="sourceCode r"><span class="fu">get_top_n_indiv</span>()</code>, to get the top n variables explaining the deviation of the score of an individual from the average predicted score in the reference set, and <code class="sourceCode r"><span class="fu">get_table_charact</span>()</code> to extract the characteristics of specific individuals given a set of characteristics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Extracts the top n variables according to absolute SHAP val</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i row number of individual</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param treeshap_res result obtained with treeshap</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n top n variables (default to 10)</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>get_top_n_indiv <span class="ot">&lt;-</span> <span class="cf">function</span>(i, treeshap_res, <span class="at">n =</span> <span class="dv">10</span>) {</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  treeshap_res<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(i) <span class="sc">|&gt;</span> </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>() <span class="sc">|&gt;</span> </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"variable"</span>, <span class="at">value =</span> <span class="st">"shap"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(shap))) <span class="sc">|&gt;</span> </span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="sc">!!</span>n) <span class="sc">|&gt;</span> </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(<span class="st">"variable"</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the characteristics of the union of top n variables among individuals</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' (using abolute SHAP values)</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' for xgboost only</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i row numbers of individuals</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param treeshap_res result obtained with treeshap</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param reference_data reference dataset</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n top n variables (default to 10)</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>get_table_charact <span class="ot">&lt;-</span> <span class="cf">function</span>(i, </span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>                              treeshap_res, </span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n =</span> <span class="dv">10</span>) {</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Top n variables for individuals</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>  top_n_indiv <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    i, </span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span><span class="fu">get_top_n_indiv</span>(<span class="at">i =</span> .x, <span class="at">treeshap_res =</span> treeshap_res, <span class="at">n =</span> n)</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>  top_n_indiv_variables <span class="ot">&lt;-</span> <span class="fu">list_c</span>(top_n_indiv) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Average values for those variables in the reference sample</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>  values_reference <span class="ot">&lt;-</span> </span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">model.matrix</span>(formula, reference_data_xgb) <span class="sc">|&gt;</span> </span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">!!</span>top_n_indiv_variables) <span class="sc">|&gt;</span> </span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">mean</span>(.x))) <span class="sc">|&gt;</span> </span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"val_ref"</span>)</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Characteristics for these individuals</span></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>  top_n_indiv_characteristics <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> i, <span class="at">.y =</span> top_n_indiv,</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span><span class="fu">tibble</span>(<span class="at">variable =</span> top_n_indiv_variables, <span class="at">id_indiv =</span> .x) <span class="sc">|&gt;</span> </span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(</span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">model.matrix</span>(formula, df_all_xgb) <span class="sc">|&gt;</span></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>          <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">slice</span>(.x) <span class="sc">|&gt;</span> </span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(<span class="sc">!!</span>top_n_indiv_variables) <span class="sc">|&gt;</span> </span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">everything</span>(), </span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"value_indiv"</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"variable"</span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">in_top_n =</span> <span class="fu">ifelse</span>(variable <span class="sc">%in%</span> .y, <span class="at">yes =</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">checkmark$"</span>, <span class="at">no =</span> <span class="st">""</span>))</span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>  top_n_indiv_characteristics <span class="sc">|&gt;</span> </span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(variable_names_categ, <span class="at">by =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(values_reference, <span class="at">by =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label), label_categ, label)) <span class="sc">|&gt;</span> </span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(label, id_indiv, value_indiv, in_top_n, val_ref) <span class="sc">|&gt;</span> </span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> id_indiv, <span class="at">values_from =</span> <span class="fu">c</span>(value_indiv, in_top_n))</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us identify two individuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>i_low <span class="ot">&lt;-</span> <span class="dv">111</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>i_high <span class="ot">&lt;-</span> <span class="dv">125</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">c</span>(pred_val_xgb[i_low], pred_val_xgb[i_high]), <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.176 0.793</code></pre>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Individual with low score</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Individual with high score</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>plot_indiv_low_pred <span class="ot">&lt;-</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_individual_variable_effect</span>(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> i_low, </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">treeshap_res =</span> treeshap_xgb, </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">predicted_val_i =</span> pred_val_xgb[i_low], </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_pred_ref =</span> mean_pred_xgb_ref, <span class="at">n =</span> <span class="dv">10</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># min_max = c(0.2, .55)</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>plot_indiv_low_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-indiv-shap-xgb-low" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-indiv-shap-xgb-low-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.3: SHAP values for an individual with a low predicted score, when the latter is estimated with XGBoost. Positive class: Imaginary healthy patient.
</figcaption>
<div aria-describedby="fig-indiv-shap-xgb-low-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-indiv-shap-xgb-low-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>plot_indiv_high_pred <span class="ot">&lt;-</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_individual_variable_effect</span>(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> i_high, </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">treeshap_res =</span> treeshap_xgb, </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">predicted_val_i =</span> pred_val_xgb[i_high], </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_pred_ref =</span> mean_pred_xgb_ref, <span class="at">n =</span> <span class="dv">10</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># min_max = c(0.4, .95)</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>plot_indiv_high_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-indiv-shap-xgb-high" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-indiv-shap-xgb-high-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.4: SHAP values for an individual with a high predicted score, when the latter is estimated with XGBoost. Positive class: Imaginary healthy patient.
</figcaption>
<div aria-describedby="fig-indiv-shap-xgb-high-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-indiv-shap-xgb-high-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>We retrieve the characteristics of the identified most important variables for both individuals, as well as the average values in the reference sample (train set):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>tb_two_indivs_example <span class="ot">&lt;-</span> <span class="fu">get_table_charact</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> <span class="fu">c</span>(i_low, i_high), </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">treeshap_res =</span> treeshap_xgb, </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">10</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then, we display them in a nice table:</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>tb_two_indivs_example <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(label, value_indiv_111, in_top_n_111, </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>         value_indiv_125, in_top_n_125, val_ref) <span class="sc">|&gt;</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">val_ref =</span> <span class="fu">round</span>(val_ref, <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> F) <span class="sc">|&gt;</span> </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unclass</span>() <span class="sc">|&gt;</span> <span class="fu">cat</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-indiv-example-low-high" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-filters="parse-latex">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-indiv-example-low-high-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;20.1: Characteristics for the Most Important Variables for Two Individuals According to their SHAP Values.
</figcaption>
<div aria-describedby="tbl-indiv-example-low-high-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class=" lightable-classic table" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
label
</th>
<th style="text-align:right;">
value_indiv_111
</th>
<th style="text-align:left;">
in_top_n_111
</th>
<th style="text-align:right;">
value_indiv_125
</th>
<th style="text-align:left;">
in_top_n_125
</th>
<th style="text-align:right;">
val_ref
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Net Income per Cons. Unit
</td>
<td style="text-align:right;">
3071.11
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
606.92
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
1622.82
</td>
</tr>
<tr>
<td style="text-align:left;">
Have to Hurry to Do Job = Sometimes
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.20
</td>
</tr>
<tr>
<td style="text-align:left;">
Gender = Male
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.47
</td>
</tr>
<tr>
<td style="text-align:left;">
Waiver Dental Care = No
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.66
</td>
</tr>
<tr>
<td style="text-align:left;">
Frequency Meeting with People in Organizations = Never
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.50
</td>
</tr>
<tr>
<td style="text-align:left;">
Very Little Freedom to Do Job = Never
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.21
</td>
</tr>
<tr>
<td style="text-align:left;">
Deduct. Pharmacy
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
9.50
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
12.64
</td>
</tr>
<tr>
<td style="text-align:left;">
Neck Pain = Yes
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.14
</td>
</tr>
<tr>
<td style="text-align:left;">
Low Back Pain = Yes
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.19
</td>
</tr>
<tr>
<td style="text-align:left;">
Waiver Appointment Delay Too Long = No
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.67
</td>
</tr>
<tr>
<td style="text-align:left;">
Age
</td>
<td style="text-align:right;">
54.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
47.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
47.59
</td>
</tr>
<tr>
<td style="text-align:left;">
No.&nbsp;Medical Sessions General Pract.
</td>
<td style="text-align:right;">
2.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
18.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
4.55
</td>
</tr>
<tr>
<td style="text-align:left;">
Waiver General Practitioner = No answer
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.21
</td>
</tr>
<tr>
<td style="text-align:left;">
Reimbursement Pharmacy
</td>
<td style="text-align:right;">
0.30
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
652.07
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
273.31
</td>
</tr>
<tr>
<td style="text-align:left;">
Reimbursement General Practitioner
</td>
<td style="text-align:right;">
30.20
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
337.10
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
83.16
</td>
</tr>
<tr>
<td style="text-align:left;">
Co-payment Pharmacy
</td>
<td style="text-align:right;">
1.85
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
251.22
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
91.03
</td>
</tr>
<tr>
<td style="text-align:left;">
Occupation = Administrative employee
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:left;">
<span class="math inline">\(\checkmark\)</span>
</td>
<td style="text-align:right;">
0.14
</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="variable-importance" class="level2" data-number="20.4">
<h2 data-number="20.4" class="anchored" data-anchor-id="variable-importance"><span class="header-section-number">20.4</span> Variable importance</h2>
<p>We compute the average absolute Shap value for each variable and order the results by descending values. We filter the results to focus on the predictions of being classified as a imaginary healthy patient.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Random Forest</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">XGBoost</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean(| SHAP |)</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>var_imp_rf_mean_abs_shap <span class="ot">&lt;-</span> treeshap_rf_opposite<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">mean</span>(<span class="fu">abs</span>(.x))))</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean(SHAP)</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>var_imp_rf_mean_shap <span class="ot">&lt;-</span> treeshap_rf_opposite<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">mean</span>(.x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We order the variables by descending values of the mean absolute SHAP values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>order_variables_shap_rf <span class="ot">&lt;-</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>(<span class="fu">unlist</span>(var_imp_rf_mean_abs_shap), <span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span> </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sort</span>(<span class="fu">unlist</span>(var_imp_rf_mean_shap), <span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">enframe</span>(<span class="at">value =</span> <span class="st">"mean"</span>),</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The top 10 variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>top_n_variables_rf <span class="ot">&lt;-</span> order_variables_shap_rf<span class="sc">$</span>name[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>top_n_variables_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "MENAGE_revucinsee"    "PERSONNE_sexe"        "QST_ct_depech"       
 [4] "OPINION1_renonc_dent" "SOINS_remomn"         "SOINS_pf_frpha"      
 [7] "PERSONNE_age"         "SOINS_tmpha"          "OPINION1_renonc_long"
[10] "PERSONNE_pb_cervical"</code></pre>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean(| SHAP |)</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>var_imp_xgb_mean_abs_shap <span class="ot">&lt;-</span> treeshap_xgb<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">mean</span>(<span class="fu">abs</span>(.x))))</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean(SHAP)</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>var_imp_xgb_mean_shap <span class="ot">&lt;-</span> treeshap_xgb<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">mean</span>(.x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We order the variables by descending values of the mean absolute SHAP values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>order_variables_shap_xgb <span class="ot">&lt;-</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>(<span class="fu">unlist</span>(var_imp_xgb_mean_abs_shap), <span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span> </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sort</span>(<span class="fu">unlist</span>(var_imp_xgb_mean_shap), <span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">enframe</span>(<span class="at">value =</span> <span class="st">"mean"</span>),</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(order_variables_shap_xgb, <span class="at">file =</span> <span class="st">"../data/out/order_variables_shap_xgb_sah.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The top 10 variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>top_n_variables_xgb <span class="ot">&lt;-</span> order_variables_shap_xgb<span class="sc">$</span>name[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>top_n_variables_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "PERSONNE_age"            "PERSONNE_sexeMale"      
 [3] "MENAGE_revucinsee"       "OPINION1_renonc_dentNo" 
 [5] "PERSONNE_pb_cervicalYes" "QES_tpsassoNever"       
 [7] "SOINS_pf_frpha"          "PERSONNE_pb_lombalgiYes"
 [9] "QST_ct_depechSometimes"  "PERSONNE_pb_allergiYes" </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Let us plot the top 10 variables by importance according to the SHAP values.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Random Forest</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">XGBoost</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>p_variable_importance_rf <span class="ot">&lt;-</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> order_variables_shap_rf <span class="sc">|&gt;</span> </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="sc">!!</span>top_n_variables_rf, </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                       label, <span class="st">"Other Variables"</span>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(label) <span class="sc">|&gt;</span> </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> <span class="fu">sum</span>(value),</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">fct_reorder</span>(label, value),</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">fct_relevel</span>(label, <span class="st">"Other Variables"</span>)</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> label, </span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> value</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Mean(|SHAP Value|)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>p_variable_importance_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-var-importance-rf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-var-importance-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.5: Variable importance according to SHAP values (with the random forest classifier)
</figcaption>
<div aria-describedby="fig-var-importance-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-var-importance-rf-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>p_variable_importance_xgb <span class="ot">&lt;-</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> order_variables_shap_xgb <span class="sc">|&gt;</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(variable_names_categ, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label), label_categ, label),</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> <span class="sc">!!</span>top_n_variables_xgb, </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>                       label, <span class="st">"Other Variables"</span>)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(label) <span class="sc">|&gt;</span> </span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> <span class="fu">sum</span>(value),</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">fct_reorder</span>(label, value),</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">fct_relevel</span>(label, <span class="st">"Other Variables"</span>)</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> label, </span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> value</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Mean(|SHAP Value|)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>p_variable_importance_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-var-importance-xgb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-var-importance-xgb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.6: Variable importance according to SHAP values (with the XGBoost classifier)
</figcaption>
<div aria-describedby="fig-var-importance-xgb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-var-importance-xgb-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The complete ranking, for both models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>order_variables_shap_xgb <span class="sc">|&gt;</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">c</span>(value, mean), <span class="sc">~</span><span class="fu">round</span>(.x, <span class="dv">4</span>)),</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rank_xgb =</span> <span class="fu">row_number</span>()</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_abs_shap_xgb =</span> value,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_shap_xgb =</span> mean</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    order_variables_shap_rf <span class="sc">|&gt;</span> </span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(<span class="fu">c</span>(value, mean), <span class="sc">~</span><span class="fu">round</span>(.x, <span class="dv">4</span>)),</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">rank_rf =</span> <span class="fu">row_number</span>()</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_abs_shap_rf =</span> value,</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_shap_rf =</span> mean</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">::</span><span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(name)`</code></pre>
</div>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-a143d3c562ea1d471fc4" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-a143d3c562ea1d471fc4">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231"],["PERSONNE_age","PERSONNE_sexeMale","MENAGE_revucinsee","OPINION1_renonc_dentNo","PERSONNE_pb_cervicalYes","QES_tpsassoNever","SOINS_pf_frpha","PERSONNE_pb_lombalgiYes","QST_ct_depechSometimes","PERSONNE_pb_allergiYes","SOINS_remomn","OPINION1_renonc_consNo answer","SOINS_seac_omn","PERSONNE_coupleYes","SOINS_rempha","QST_ct_liberteNever","OPINION1_renonc_longNo","QST_ct_aidecolSometimes","SOINS_tmpha","MENAGE_nbpers","SOINS_remspe","SOINS_tmomn","PERSONNE_rap_pcs8Administrative employee","PERSONNE_aldNo","OPINION1_renonc_dentNo answer","QST_ct_depechOften","SOINS_dpaspe","SOINS_pf_frspe","MUTUELLE_assuBeneficiary","SOINS_tmden","QES_tpsassoAt least once a week","ensol_2011","SOINS_dpaopt","MUTUELLE_typccMutual insurance","PERSONNE_rap_pcs8Commercial employee","QES_tpsfamilAt least once a week","OPINION1_renonc_finNo answer","SOINS_seac_spe","SOINS_pf_fromn","QST_ct_repetNever","QES_associationNo","QST_ct_liberteSometimes","MENAGE_tu","MUTUELLE_assuNo answer","SOINS_tmspe","QST_ct_repetNo answer","QST_ct_travnuitNever","QST_ct_lourdNo answer","OPINION1_renonc_loinNo answer","QES_tpsamiAt least once a week","SOINS_tminf","QST_ct_produitNo answer","QES_pere_etudeNursery School, Primary school, Certificate of studies","SOINS_remden","PERSONNE_ssYes (third party)","QST_ct_travnuitNo answer","QES_tpscollegNever","QES_mere_etudeNursery School, Primary school, Certificate of studies","QST_ct_depechNo answer","QST_ct_lourdNever","OPINION1_renonc_longNo answer","SOINS_reminf","OPINION1_renonc_consNo","MUTUELLE_typccPrivate insurance","MUTUELLE_assuSelf insured","QES_tpsamiAt least once a month","QST_ct_aidecolNo answer","PERSONNE_pb_asthmYes","PERSONNE_pb_asthmNo answer","PERSONNE_pb_bronchitYes","PERSONNE_pb_bronchitNo answer","PERSONNE_pb_infarctusYes","PERSONNE_pb_infarctusNo answer","PERSONNE_pb_coronairYes","PERSONNE_pb_coronairNo answer","PERSONNE_pb_hypertensYes","PERSONNE_pb_hypertensNo answer","PERSONNE_pb_avcYes","PERSONNE_pb_avcNo answer","PERSONNE_pb_arthrosYes","PERSONNE_pb_arthrosNo answer","PERSONNE_pb_lombalgiNo answer","PERSONNE_pb_cervicalNo answer","PERSONNE_pb_diabetYes","PERSONNE_pb_diabetNo answer","PERSONNE_pb_allergiNo answer","PERSONNE_pb_cirrhosYes","PERSONNE_pb_cirrhosNo answer","PERSONNE_pb_urinairYes","PERSONNE_pb_urinairNo answer","PERSONNE_coupleNo answer","PERSONNE_regimePublic service","PERSONNE_regimeThe local Alsace-Moselle scheme","PERSONNE_regimeThe basic Universal Health Coverage","PERSONNE_regimeThe agricultural scheme","PERSONNE_regimeThe self-employed scheme","PERSONNE_regimeOther (Student, abroad, other)","PERSONNE_regimeDoes not know","PERSONNE_rap_pcs8Craftsman, trader","PERSONNE_rap_pcs8Executive and intellectual profession","PERSONNE_rap_pcs8Intermediate occupation","PERSONNE_rap_pcs8Skilled worker","PERSONNE_rap_pcs8Unskilled worker","PERSONNE_rap_pcs8Inactive having never worked","PERSONNE_aldDoes not know","SOINS_ald_amNo","SOINS_ald_amNo answer","MUTUELLE_typccPension fund","MUTUELLE_typccInsurance broker","MUTUELLE_typccNo answer","SOINS_remkin","SOINS_remmat","SOINS_remtra","SOINS_remopt","SOINS_rempro","SOINS_remurg","SOINS_tmkin","SOINS_tmmat","SOINS_tmtra","SOINS_tmopt","SOINS_tmpro","SOINS_tmurg","SOINS_dpaomn","SOINS_dpapha","SOINS_dpakin","SOINS_dpainf","SOINS_dpaden","SOINS_dpamat","SOINS_dpatra","SOINS_dpapro","SOINS_dpaurg","SOINS_pf_frkin","SOINS_pf_frinf","SOINS_pf_frden","SOINS_pf_frtra","SOINS_pf_frurg","OPINION1_renonc_finNo","OPINION1_renonc_loinNo","QST_ct_depechNever","QST_ct_liberteOften","QST_ct_liberteNo answer","QST_ct_apprendOften","QST_ct_apprendSometimes","QST_ct_apprendNever","QST_ct_apprendNo answer","QST_ct_aidecolOften","QST_ct_aidecolNever","QST_ct_aidecolNot concered","QST_ct_travnuitOften","QST_ct_travnuitSometimes","QST_ct_repetOften","QST_ct_repetSometimes","QST_ct_lourdOften","QST_ct_lourdSometimes","QST_ct_postureOften","QST_ct_postureSometimes","QST_ct_postureNever","QST_ct_postureNo answer","QST_ct_produitOften","QST_ct_produitSometimes","QST_ct_produitNever","QES_associationNo answer","QES_tpsamiLess than once a month","QES_tpsamiNever","QES_tpsamiNo answer","QES_tpsassoAt least once a month","QES_tpsassoLess than once a month","QES_tpsassoNo answer","QES_tpscollegAt least once a week","QES_tpscollegAt least once a month","QES_tpscollegLess than once a month","QES_tpscollegNo answer","QES_tpsfamilAt least once a month","QES_tpsfamilLess than once a month","QES_tpsfamilNever","QES_tpsfamilNo answer","QES_mere_etude1st cycle (~Middle School)","QES_mere_etude2nd cycle (~High School","QES_mere_etudeHigher Education","QES_mere_etudeOther","QES_mere_etudeDoes not know","QES_mere_etudeNo answer","QES_pere_etude1st cycle (~Middle School)","QES_pere_etude2nd cycle (~High School","QES_pere_etudeHigher Education","QES_pere_etudeOther","QES_pere_etudeDoes not know","QES_pere_etudeNo answer","PERSONNE_sexe","QST_ct_depech","OPINION1_renonc_dent","OPINION1_renonc_long","PERSONNE_pb_cervical","OPINION1_renonc_cons","PERSONNE_pb_lombalgi","QES_tpsami","PERSONNE_pb_allergi","QES_tpsasso","QST_ct_liberte","PERSONNE_rap_pcs8","QES_tpsfamil","OPINION1_renonc_fin","MUTUELLE_typcc","OPINION1_renonc_loin","QST_ct_repet","QES_pere_etude","PERSONNE_couple","MUTUELLE_assu","QES_association","PERSONNE_regime","QST_ct_posture","QES_mere_etude","PERSONNE_pb_bronchit","QST_ct_lourd","QST_ct_produit","QST_ct_apprend","QST_ct_aidecol","PERSONNE_ald","PERSONNE_pb_urinair","PERSONNE_pb_diabet","PERSONNE_pb_asthm","QES_tpscolleg","SOINS_ald_am","PERSONNE_pb_hypertens","QST_ct_travnuit","PERSONNE_pb_arthros","PERSONNE_ss","PERSONNE_pb_coronair","PERSONNE_pb_infarctus","PERSONNE_pb_cirrhos","PERSONNE_pb_avc"],[0.1518,0.1294,0.1189,0.102,0.0863,0.081,0.07920000000000001,0.0751,0.07439999999999999,0.0697,0.0614,0.0549,0.0518,0.0513,0.0438,0.0432,0.0426,0.0424,0.0355,0.0309,0.0282,0.0264,0.0215,0.0211,0.0174,0.0158,0.0143,0.0141,0.0139,0.013,0.0127,0.0114,0.0113,0.0108,0.0108,0.0095,0.008699999999999999,0.0086,0.0073,0.0069,0.0059,0.0053,0.0048,0.0037,0.0036,0.0032,0.0028,0.0027,0.0024,0.0022,0.0016,0.0016,0.0016,0.0015,0.0014,0.0014,0.0013,0.0013,0.0012,0.001,0.001,0.0009,0.0004,0.0004,0.0004,0.0004,0.0003,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[-0.0146,-0.0017,-0.0086,-0.0146,-0.008399999999999999,-0.0029,-0.0032,-0.0057,-0.0072,-0.0071,-0.008500000000000001,0.0155,-0.0058,-0.0001,-0.0033,-0.0031,-0.0203,-0,-0.0032,0.0031,-0.0026,-0.001,-0.001,-0.0005999999999999999,0.0049,-0.001,-0.0004,-0.0009,0,-0.0002,-0.0004,-0.0004,-0.0002,-0.0004,-0.0009,-0.0003,0.0021,-0.0005,-0.0005999999999999999,0.0005,-0.0002,0.0013,-0.0003,0,-0.001,0.0001,0,0.0003,0.0009,-0.0001,-0,0.0001,0.0002,0,-0,-0.0001,-0.0001,0.0001,0.0001,-0.0001,0,-0.0002,-0,0,-0.0001,0,-0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[0.0124,null,0.0203,null,null,null,0.0128,null,null,null,0.0134,null,0.009900000000000001,null,0.008699999999999999,null,null,null,0.0121,0.0025,0.0067,0.0074,null,null,null,null,0.0019,0.0033,null,0.0041,null,0.0029,0.0041,null,null,null,null,0.0044,0.0065,null,null,null,0.0038,null,0.0042,null,null,null,null,null,0.0012,null,null,0.0025,null,null,null,null,null,null,null,0.002,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0.0027,0.0028,0.003,0.0027,0.001,0.0024,0.0024,0.0019,0.0018,0.0022,0.0009,0.0021,0.0027,0.0001,0.0002,0.0001,0.003,0.0013,0.0001,0.0013,0,0.0012,0.0007,0.0001,0.0009,0.0011,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0.0178,0.0168,0.0163,0.0115,0.0114,0.0091,0.0089,0.008500000000000001,0.008200000000000001,0.0078,0.0073,0.0071,0.0055,0.0047,0.0044,0.0038,0.0037,0.0034,0.0032,0.0032,0.0031,0.0029,0.0028,0.0025,0.0025,0.0024,0.0024,0.0022,0.0022,0.0022,0.002,0.0019,0.0015,0.0011,0.0011,0.001,0.0007,0.0005999999999999999,0.0005999999999999999,0.0003,0.0002,0.0002,0.0001],[0.0012,null,-0.0005999999999999999,null,null,null,-0.0012,null,null,null,-0.0005999999999999999,null,-0.001,null,-0.0002,null,null,null,-0.0011,0.0003,0.0005,0,null,null,null,null,0.0004,0.0002,null,0.0004,null,0.0002,0.0004,null,null,null,null,-0.0005999999999999999,-0.0001,null,null,null,-0.0001,null,-0.0002,null,null,null,null,null,0.0002,null,null,0,null,null,null,null,null,null,null,0,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0.0002,-0.0002,-0.0001,0.0001,0.0002,0.0002,0.0003,0.0001,-0,0.0003,0.0002,0,0.0003,-0,-0,-0,0.0002,0.0001,-0,0.0001,-0,0.0002,0.0002,-0,-0.0001,0,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,-0.0001,-0.0008,-0.0001,0,-0.0005,0.0003,-0.0004,-0.0001,-0.0007,0,-0.0001,0.0005999999999999999,0.0001,-0.0001,-0.0003,0,0.0001,0.0002,-0.0002,-0,-0,0.0001,0.0001,0.0001,0.0005,0.0003,0.0004,-0.0003,-0,0.0002,0.0002,-0,0.0001,0.0001,0.0001,0.0003,0.0003,0.0001,0.0002,0.0001,0.0001,0.0001,0.0001],[7,null,1,null,null,null,6,null,null,null,5,null,11,null,14,null,null,null,8,47,21,18,null,null,null,null,63,34,null,29,null,40,28,null,null,null,null,25,22,null,null,null,31,null,27,null,null,null,null,null,69,null,null,48,null,null,null,null,null,null,null,60,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,46,42,39,45,75,51,54,62,65,55,76,59,44,88,85,87,38,67,90,68,91,70,79,89,77,71,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,2,3,4,9,10,12,13,15,16,17,19,20,23,24,26,30,32,33,35,36,37,41,43,49,50,52,53,56,57,58,61,64,66,72,73,74,78,80,81,82,83,84,86]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>name<\/th>\n      <th>mean_abs_shap_xgb<\/th>\n      <th>mean_shap_xgb<\/th>\n      <th>rank_xgb<\/th>\n      <th>mean_abs_shap_rf<\/th>\n      <th>mean_shap_rf<\/th>\n      <th>rank_rf<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"name","targets":1},{"name":"mean_abs_shap_xgb","targets":2},{"name":"mean_shap_xgb","targets":3},{"name":"rank_xgb","targets":4},{"name":"mean_abs_shap_rf","targets":5},{"name":"mean_shap_rf","targets":6},{"name":"rank_rf","targets":7}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>In Python, the <code class="sourceCode r"><span class="fu">summary_plot</span>()</code> function is used to offer a quick view of the effect of each variable on the prediction. We can reproduce such a plot. For quantitative variables, this type of graph seems advantageous. For quantitative variables, on the other hand, we prefer a different type of graph (see below).</p>
<p>Let us define a function to rescale values (min-max rescaling).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' std1</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' a function to standardize feature values into same range</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Source: https://github.com/pablo14/shap-values/blob/master/shap.R</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>std1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  ((x <span class="sc">-</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> T)) <span class="sc">/</span> (<span class="fu">max</span>(x, <span class="at">na.rm =</span> T) <span class="sc">-</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> T)))</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we need to create a table that contains for each individual and each variable, the Shap value, and the standardized value of the characteristics.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">Random Forest</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">XGBoost</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>values_min_max_rf <span class="ot">&lt;-</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  df_all_rf <span class="sc">|&gt;</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!!</span>top_n_variables_rf) <span class="sc">|&gt;</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_value =</span> <span class="fu">min</span>(value), <span class="at">max_value =</span> <span class="fu">max</span>(value),</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">med_value =</span> <span class="fu">median</span>(value),</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">q1_value =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> .<span class="dv">25</span>),</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">q3_value =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> .<span class="dv">75</span>)</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>values_min_max_xgb <span class="ot">&lt;-</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="fu">model.matrix</span>(formula, df_all_xgb)) <span class="sc">|&gt;</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!!</span>top_n_variables_xgb) <span class="sc">|&gt;</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_value =</span> <span class="fu">min</span>(value), <span class="at">max_value =</span> <span class="fu">max</span>(value),</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">med_value =</span> <span class="fu">median</span>(value),</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">q1_value =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> .<span class="dv">25</span>),</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">q3_value =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> .<span class="dv">75</span>)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>We format the data to be able to create the plot.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">Random Forest</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">XGBoost</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>df_plot_rf <span class="ot">&lt;-</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  treeshap_rf_opposite<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!!</span>top_n_variables_rf) <span class="sc">|&gt;</span> </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_row =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>id_row, <span class="at">values_to =</span> <span class="st">"shap"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    df_all_rf <span class="sc">|&gt;</span> </span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">!!</span>top_n_variables_rf) <span class="sc">|&gt;</span> </span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id_row =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>id_row, <span class="at">values_to =</span> <span class="st">"value"</span>),</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id_row"</span>, <span class="st">"name"</span>)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_shap_value =</span> <span class="fu">std1</span>(shap),</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_shap_value =</span> <span class="fu">mean</span>(shap),</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_abs_shap_value =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(shap))</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    values_min_max_rf,</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">value_variable_std =</span> (value <span class="sc">-</span> min_value) <span class="sc">/</span> (max_value <span class="sc">-</span> min_value)</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">fct_reorder</span>(label, mean_abs_shap_value)</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>df_plot_xgb <span class="ot">&lt;-</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  treeshap_xgb<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!!</span>top_n_variables_xgb) <span class="sc">|&gt;</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_row =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>id_row, <span class="at">values_to =</span> <span class="st">"shap"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>(<span class="fu">model.matrix</span>(formula, df_all_xgb)) <span class="sc">|&gt;</span> </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">!!</span>top_n_variables_xgb) <span class="sc">|&gt;</span> </span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id_row =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>id_row, <span class="at">values_to =</span> <span class="st">"value"</span>),</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id_row"</span>, <span class="st">"name"</span>)</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_shap_value =</span> <span class="fu">std1</span>(shap),</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_shap_value =</span> <span class="fu">mean</span>(shap),</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_abs_shap_value =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(shap))</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    values_min_max_xgb,</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">value_variable_std =</span> (value <span class="sc">-</span> min_value) <span class="sc">/</span> (max_value <span class="sc">-</span> min_value)</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variable_names_categ, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label), label_categ, label),</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">fct_reorder</span>(label, mean_abs_shap_value)</span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Then, using the <code class="sourceCode r"><span class="fu">geom_sina</span>()</code> function from {<code>ggforce</code>}, we can create the summary plot. Each dot, for each variable given in the y-axis represent an individual. The x-axis gives the estimated Shap value of the variable for each individual. The colours state whether the value of the variable for a specific individual is low (blue) or high (red), using the standardized value as the reference. The variables on the y-axis appear according to their relative importance in explaining the prediction. For example, the graph shows that pharmacy deductible amounts are relatively important in explaining the probability of being classified as an imaginary healthy patient. When the value of this franchise is low (blue dots), this variable influences the prediction downwards (since the blue dots are mostly associated with negative Shap values); conversely, when the pharmacy franchise is high (red dots), the probability of being classified as an imaginary healthy patient increases.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true">Random Forest</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false">XGBoost</a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggforce)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>p_rf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_plot_rf,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> shap, </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> label, </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> value_variable_std</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sina</span>(<span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Feature value"</span>,</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">low=</span><span class="st">"#0081BC"</span>, <span class="at">high =</span> <span class="st">"#EE324E"</span>,</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"High"</span>),</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="dv">40</span>,</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> .<span class="dv">5</span>,</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="dv">0</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"SHAP value (impact on model output)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.height   =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"line"</span>),</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width    =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">"line"</span>)</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>p_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-shap-effect-variables-rf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-shap-effect-variables-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.7: Estimated effect of variables on the probability of being predicted an imaginary healthy patienteach individual (random forest)
</figcaption>
<div aria-describedby="fig-shap-effect-variables-rf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-shap-effect-variables-rf-1.png" class="img-fluid figure-img" width="576">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>p_xgb <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_plot_xgb,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> shap, </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> label, </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> value_variable_std</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sina</span>(<span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Feature value"</span>,</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">low=</span><span class="st">"#0081BC"</span>, <span class="at">high =</span> <span class="st">"#EE324E"</span>,</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"High"</span>),</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="dv">40</span>,</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> .<span class="dv">5</span>,</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="dv">0</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"SHAP value (impact on model output)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.height   =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"line"</span>),</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width    =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">"line"</span>)</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>p_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-shap-effect-variables-xgb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-shap-effect-variables-xgb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.8: Estimated effect of variables on the probability of being predicted an imaginary healthy patienteach individual (XGBoost)
</figcaption>
<div aria-describedby="fig-shap-effect-variables-xgb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-shap-effect-variables-xgb-1.png" class="img-fluid figure-img" width="576">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Now, instead of a summary plot, let us create a plot for each of the variables in the top n.&nbsp;To that end, we create a function which plots the estimated SHAP values for a single variable for each individuals. When the variable is categorical, we want the graph to be split depending on the categories.</p>
<p>For continuous variable, we may want to make the colors of the dots depend on the quantiles. This is the case for net income, because of the shape of the distribution:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(df_all_rf<span class="sc">$</span>MENAGE_revucinsee, <span class="at">breaks =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="robustness-shap-results-sah_files/figure-html/plot-hist-income-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df_all_rf<span class="sc">$</span>MENAGE_revucinsee)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
     74    1000    1400    1620    2000   25300 </code></pre>
</div>
</div>
<p>The code of the plot function is a bit long.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-10-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-1" role="tab" aria-controls="tabset-10-1" aria-selected="true">Random Forest</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-2" role="tab" aria-controls="tabset-10-2" aria-selected="false">XGBoost</a></li></ul>
<div class="tab-content">
<div id="tabset-10-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-10-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plots the SHAP values for each individuals, for a single variable</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param variable_name name of the variable</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param treeshap_res treeshap results</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param df_all data frame with observations from train and test sets</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param quantile if TRUE, uses the empirical quantiles as the colour code (default to FALSE)</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param size_dots size of the dots</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param bar_width legend bar width for qualitative variables</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>plot_shap_all_indiv_variable_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(variable_name, </span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>                                            treeshap_res,</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>                                            df_all,</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">quantile =</span> <span class="cn">FALSE</span>, </span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">size_dots =</span> .<span class="dv">6</span>, </span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">bar_width =</span> <span class="dv">30</span>) {</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="ot">&lt;-</span> </span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    treeshap_res<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">!!</span>variable_name) <span class="sc">|&gt;</span> </span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">SHAP_value =</span> <span class="sc">!!</span>variable_name) <span class="sc">|&gt;</span> </span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">variable_name =</span> variable_name) <span class="sc">|&gt;</span> </span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value of the variable from the dataset</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable_value =</span> df_all <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>variable_name)</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>  is_factor <span class="ot">&lt;-</span> variable_name <span class="sc">%in%</span> <span class="fu">names</span>(corresp_factors)</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (is_factor <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the levels for the variable</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    niveaux <span class="ot">&lt;-</span> corresp_factors[[variable_name]]</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    df_plot <span class="ot">&lt;-</span> </span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>      df_plot <span class="sc">|&gt;</span> </span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(</span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">variable_value =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(niveaux),</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>          <span class="at">variable_value_level =</span> niveaux</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"variable_value"</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(niveaux <span class="sc">==</span> <span class="st">"No answer"</span>)) {</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>      nouveaux_niveaux <span class="ot">&lt;-</span> niveaux</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>      nouveaux_niveaux[nouveaux_niveaux <span class="sc">==</span> <span class="st">"No answer"</span>] <span class="ot">&lt;-</span> <span class="st">"Did not answer"</span></span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">"At least once a month"</span> <span class="sc">%in%</span> niveaux) {</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>        ordre_niveaux <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Every day or almost every day"</span>,</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>          <span class="st">"At least once a week"</span>,</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>          <span class="st">"At least once a month"</span>,</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Less than once a month"</span>, <span class="st">"Never"</span>, <span class="st">"Did not answer"</span></span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>        ordre_niveaux_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(niveaux, nouveaux_niveaux) <span class="sc">|&gt;</span> </span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>            <span class="at">nouveaux_niveaux =</span> <span class="fu">factor</span>(nouveaux_niveaux, <span class="at">levels =</span> ordre_niveaux)</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span> </span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>          <span class="fu">arrange</span>(<span class="fu">desc</span>(nouveaux_niveaux))</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>        niveaux <span class="ot">&lt;-</span> ordre_niveaux_tbl<span class="sc">$</span>niveaux</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>        nouveaux_niveaux <span class="ot">&lt;-</span> <span class="fu">as.character</span>(ordre_niveaux_tbl<span class="sc">$</span>nouveaux_niveaux)</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (<span class="st">"Sometimes"</span> <span class="sc">%in%</span> niveaux) {</span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>        ordre_niveaux <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Always"</span>, <span class="st">"Often"</span>, <span class="st">"Sometimes"</span>, <span class="st">"Never"</span>, <span class="st">"Did not answer"</span>)</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>        ordre_niveaux_tbl <span class="ot">&lt;-</span> </span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>          <span class="fu">tibble</span>(niveaux, nouveaux_niveaux) <span class="sc">|&gt;</span> </span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">nouveaux_niveaux =</span> <span class="fu">factor</span>(nouveaux_niveaux, <span class="at">levels =</span> ordre_niveaux)</span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span> </span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>          <span class="fu">arrange</span>(<span class="fu">desc</span>(nouveaux_niveaux))</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>        niveaux <span class="ot">&lt;-</span> ordre_niveaux_tbl<span class="sc">$</span>niveaux</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>        nouveaux_niveaux <span class="ot">&lt;-</span> <span class="fu">as.character</span>(ordre_niveaux_tbl<span class="sc">$</span>nouveaux_niveaux)</span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>      df_plot <span class="ot">&lt;-</span> </span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>        df_plot <span class="sc">|&gt;</span> <span class="fu">left_join</span>(</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>          <span class="fu">tibble</span>(</span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>            <span class="at">variable_value_level =</span> niveaux, </span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>            <span class="at">variable_value_level_new =</span> nouveaux_niveaux</span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>          <span class="at">by =</span> <span class="st">"variable_value_level"</span></span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span> </span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>variable_value_level) <span class="sc">|&gt;</span> </span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="at">variable_value_level =</span> variable_value_level_new)</span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>      niveaux <span class="ot">&lt;-</span> nouveaux_niveaux</span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a>    df_plot <span class="ot">&lt;-</span> df_plot <span class="sc">|&gt;</span> </span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable_value_level =</span> <span class="fu">factor</span>(variable_value_level, <span class="at">levels =</span> niveaux)</span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (is_factor <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> </span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggplot</span>(</span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df_plot, </span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> SHAP_value, </span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> variable_value_level</span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb80-101"><a href="#cb80-101" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sina</span>(<span class="at">size =</span> size_dots) <span class="sc">+</span></span>
<span id="cb80-102"><a href="#cb80-102" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_violin</span>(<span class="at">alpha=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb80-103"><a href="#cb80-103" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb80-104"><a href="#cb80-104" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"SHAP value (impact on model output)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span>
<span id="cb80-105"><a href="#cb80-105" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb80-106"><a href="#cb80-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-107"><a href="#cb80-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (quantile <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb80-108"><a href="#cb80-108" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb80-109"><a href="#cb80-109" aria-hidden="true" tabindex="-1"></a>      df_plot<span class="sc">$</span>quantile_variable <span class="ot">&lt;-</span> </span>
<span id="cb80-110"><a href="#cb80-110" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cut</span>(</span>
<span id="cb80-111"><a href="#cb80-111" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(df_plot, <span class="st">"variable_value"</span>),</span>
<span id="cb80-112"><a href="#cb80-112" aria-hidden="true" tabindex="-1"></a>          <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb80-113"><a href="#cb80-113" aria-hidden="true" tabindex="-1"></a>            <span class="st">"$</span><span class="sc">\\</span><span class="st">leq$ D1"</span>, <span class="st">"D1 to D2"</span>, <span class="st">"D2 to D3"</span>, <span class="st">"D3 to D4"</span>,</span>
<span id="cb80-114"><a href="#cb80-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">"D4 to D5"</span>, <span class="st">"D5 to D6"</span>, <span class="st">"D6 to D7"</span>, <span class="st">"D7 to D8"</span>, </span>
<span id="cb80-115"><a href="#cb80-115" aria-hidden="true" tabindex="-1"></a>            <span class="st">"D8 to D9"</span>, <span class="st">"&gt; D9"</span></span>
<span id="cb80-116"><a href="#cb80-116" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb80-117"><a href="#cb80-117" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> <span class="fu">c</span>(</span>
<span id="cb80-118"><a href="#cb80-118" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span>,</span>
<span id="cb80-119"><a href="#cb80-119" aria-hidden="true" tabindex="-1"></a>            <span class="fu">quantile</span>(</span>
<span id="cb80-120"><a href="#cb80-120" aria-hidden="true" tabindex="-1"></a>              magrittr<span class="sc">::</span><span class="fu">extract2</span>(df_all, variable_name),</span>
<span id="cb80-121"><a href="#cb80-121" aria-hidden="true" tabindex="-1"></a>              <span class="at">probs =</span> <span class="fu">seq</span>(.<span class="dv">1</span>, .<span class="dv">9</span>, .<span class="dv">1</span>)</span>
<span id="cb80-122"><a href="#cb80-122" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb80-123"><a href="#cb80-123" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Inf</span></span>
<span id="cb80-124"><a href="#cb80-124" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb80-125"><a href="#cb80-125" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-126"><a href="#cb80-126" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb80-127"><a href="#cb80-127" aria-hidden="true" tabindex="-1"></a>      df_plot <span class="ot">&lt;-</span> </span>
<span id="cb80-128"><a href="#cb80-128" aria-hidden="true" tabindex="-1"></a>        df_plot <span class="sc">|&gt;</span> </span>
<span id="cb80-129"><a href="#cb80-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">quantile_revenu_num =</span> <span class="fu">as.numeric</span>(quantile_variable))</span>
<span id="cb80-130"><a href="#cb80-130" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb80-131"><a href="#cb80-131" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> </span>
<span id="cb80-132"><a href="#cb80-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(</span>
<span id="cb80-133"><a href="#cb80-133" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> df_plot <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="dv">1</span>),,</span>
<span id="cb80-134"><a href="#cb80-134" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb80-135"><a href="#cb80-135" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> SHAP_value,</span>
<span id="cb80-136"><a href="#cb80-136" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> x,</span>
<span id="cb80-137"><a href="#cb80-137" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> quantile_revenu_num</span>
<span id="cb80-138"><a href="#cb80-138" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb80-139"><a href="#cb80-139" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb80-140"><a href="#cb80-140" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_sina</span>(<span class="at">alpha =</span> .<span class="dv">5</span>, <span class="at">size =</span> size_dots) <span class="sc">+</span></span>
<span id="cb80-141"><a href="#cb80-141" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb80-142"><a href="#cb80-142" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_color_gradient</span>(</span>
<span id="cb80-143"><a href="#cb80-143" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Variable value"</span>,</span>
<span id="cb80-144"><a href="#cb80-144" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">10</span>),</span>
<span id="cb80-145"><a href="#cb80-145" aria-hidden="true" tabindex="-1"></a>          <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">leq$ D1"</span>, <span class="st">"D3 to D4"</span>, <span class="st">"D6 to D7"</span>, <span class="st">"$&gt;$ D9"</span>),</span>
<span id="cb80-146"><a href="#cb80-146" aria-hidden="true" tabindex="-1"></a>          <span class="at">low =</span> <span class="st">"#0081BC"</span>, <span class="at">high =</span> <span class="st">"#EE324E"</span>,</span>
<span id="cb80-147"><a href="#cb80-147" aria-hidden="true" tabindex="-1"></a>          <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb80-148"><a href="#cb80-148" aria-hidden="true" tabindex="-1"></a>            <span class="at">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb80-149"><a href="#cb80-149" aria-hidden="true" tabindex="-1"></a>            <span class="at">barwidth =</span> bar_width,</span>
<span id="cb80-150"><a href="#cb80-150" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb80-151"><a href="#cb80-151" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.hjust =</span> .<span class="dv">5</span></span>
<span id="cb80-152"><a href="#cb80-152" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb80-153"><a href="#cb80-153" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb80-154"><a href="#cb80-154" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"SHAP value (impact on model output)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb80-155"><a href="#cb80-155" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(</span>
<span id="cb80-156"><a href="#cb80-156" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb80-157"><a href="#cb80-157" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"line"</span>),</span>
<span id="cb80-158"><a href="#cb80-158" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.width  =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">"line"</span>),</span>
<span id="cb80-159"><a href="#cb80-159" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb80-160"><a href="#cb80-160" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb80-161"><a href="#cb80-161" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb80-162"><a href="#cb80-162" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coord_flip</span>()</span>
<span id="cb80-163"><a href="#cb80-163" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb80-164"><a href="#cb80-164" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb80-165"><a href="#cb80-165" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Not using quantile</span></span>
<span id="cb80-166"><a href="#cb80-166" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> </span>
<span id="cb80-167"><a href="#cb80-167" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(</span>
<span id="cb80-168"><a href="#cb80-168" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> df_plot <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="dv">1</span>),</span>
<span id="cb80-169"><a href="#cb80-169" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb80-170"><a href="#cb80-170" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> x,</span>
<span id="cb80-171"><a href="#cb80-171" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> SHAP_value,</span>
<span id="cb80-172"><a href="#cb80-172" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> variable_value</span>
<span id="cb80-173"><a href="#cb80-173" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb80-174"><a href="#cb80-174" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb80-175"><a href="#cb80-175" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_sina</span>(<span class="at">alpha =</span> .<span class="dv">5</span>, <span class="at">size =</span> size_dots) <span class="sc">+</span></span>
<span id="cb80-176"><a href="#cb80-176" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb80-177"><a href="#cb80-177" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_color_gradient</span>(</span>
<span id="cb80-178"><a href="#cb80-178" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Variable value"</span>,</span>
<span id="cb80-179"><a href="#cb80-179" aria-hidden="true" tabindex="-1"></a>          <span class="at">low =</span> <span class="st">"#0081BC"</span>, <span class="at">high =</span> <span class="st">"#EE324E"</span>,</span>
<span id="cb80-180"><a href="#cb80-180" aria-hidden="true" tabindex="-1"></a>          <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb80-181"><a href="#cb80-181" aria-hidden="true" tabindex="-1"></a>            <span class="at">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb80-182"><a href="#cb80-182" aria-hidden="true" tabindex="-1"></a>            <span class="at">barwidth =</span> bar_width,</span>
<span id="cb80-183"><a href="#cb80-183" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb80-184"><a href="#cb80-184" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.hjust =</span> .<span class="dv">5</span>)</span>
<span id="cb80-185"><a href="#cb80-185" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb80-186"><a href="#cb80-186" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"SHAP value (impact on model output)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb80-187"><a href="#cb80-187" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(</span>
<span id="cb80-188"><a href="#cb80-188" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb80-189"><a href="#cb80-189" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"line"</span>),</span>
<span id="cb80-190"><a href="#cb80-190" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.width  =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">"line"</span>),</span>
<span id="cb80-191"><a href="#cb80-191" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb80-192"><a href="#cb80-192" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb80-193"><a href="#cb80-193" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb80-194"><a href="#cb80-194" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coord_flip</span>()</span>
<span id="cb80-195"><a href="#cb80-195" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-196"><a href="#cb80-196" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-197"><a href="#cb80-197" aria-hidden="true" tabindex="-1"></a>  p <span class="sc">+</span> <span class="fu">theme</span>(</span>
<span id="cb80-198"><a href="#cb80-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb80-199"><a href="#cb80-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.3</span>), <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb80-200"><a href="#cb80-200" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(.<span class="dv">8</span>)),</span>
<span id="cb80-201"><a href="#cb80-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(.<span class="dv">8</span>))</span>
<span id="cb80-202"><a href="#cb80-202" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-203"><a href="#cb80-203" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true">Net Income per Cons. Unit</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false">Gender</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-3" role="tab" aria-controls="tabset-8-3" aria-selected="false">Have to Hurry to Do Job</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-4" role="tab" aria-controls="tabset-8-4" aria-selected="false">Waiver Dental Care</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-5" role="tab" aria-controls="tabset-8-5" aria-selected="false">Reimbursement General Practitioner</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-6" role="tab" aria-controls="tabset-8-6" aria-selected="false">Deduct. Pharmacy</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-7" role="tab" aria-controls="tabset-8-7" aria-selected="false">Age</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-8" role="tab" aria-controls="tabset-8-8" aria-selected="false">Co-payment Pharmacy</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-9" role="tab" aria-controls="tabset-8-9" aria-selected="false">Waiver Appointment Delay Too Long</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-10-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-10" role="tab" aria-controls="tabset-8-10" aria-selected="false">Neck Pain</a></li></ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Net Income per Cons. Unit</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-105-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Gender</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-107-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-3-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Have to Hurry to Do Job</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-109-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-4-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Waiver Dental Care</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-111-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-5-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Reimbursement General Practitioner</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-113-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-6-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Deduct. Pharmacy</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-115-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-7-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Age</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-117-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-8-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Co-payment Pharmacy</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-119-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-9-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Waiver Appointment Delay Too Long</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-121-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-10" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-10-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Neck Pain</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-123-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-10-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plots the SHAP values for each individuals, for a single variable</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param variable_name name of the variable</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param treeshap_res treeshap results</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param df_all data frame with observations from train and test sets</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param quantile if TRUE, uses the empirical quantiles as the colour code (default to FALSE)</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param size_dots size of the dots</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param bar_width legend bar width for qualitative variables</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>plot_shap_all_indiv_variable_xgb <span class="ot">&lt;-</span> <span class="cf">function</span>(variable_name, </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>                                             treeshap_res,</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>                                             df_all,</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">quantile =</span> <span class="cn">FALSE</span>, </span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">size_dots =</span> .<span class="dv">6</span>, </span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">bar_width =</span> <span class="dv">30</span>) {</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="ot">&lt;-</span> </span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    treeshap_res<span class="sc">$</span>shaps <span class="sc">|&gt;</span> </span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">!!</span>variable_name) <span class="sc">|&gt;</span> </span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">SHAP_value =</span> <span class="sc">!!</span>variable_name) <span class="sc">|&gt;</span> </span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">variable_name =</span> variable_name) <span class="sc">|&gt;</span> </span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value of the variable from the dataset</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable_value =</span> df_all <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>variable_name)</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>  is_factor <span class="ot">&lt;-</span> variable_name <span class="sc">%in%</span> variable_names_categ<span class="sc">$</span>variable</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (is_factor <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Not using quantile</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggplot</span>(</span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df_plot <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="dv">1</span>),</span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> x,</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> SHAP_value,</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> variable_value</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sina</span>(<span class="at">alpha =</span> .<span class="dv">5</span>, <span class="at">size =</span> size_dots) <span class="sc">+</span></span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_color_gradient</span>(</span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Variable value"</span>,</span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">low =</span> <span class="st">"#0081BC"</span>, <span class="at">high =</span> <span class="st">"#EE324E"</span>, <span class="at">n.breaks =</span> <span class="dv">2</span></span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"SHAP value (impact on model output)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"line"</span>),</span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width  =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">"line"</span>),</span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(</span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"#0081BC"</span>, <span class="st">"#EE324E"</span>),</span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>)</span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>      )))</span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (quantile <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a>      breaks_q <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span>,</span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">quantile</span>(</span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a>          magrittr<span class="sc">::</span><span class="fu">extract2</span>(df_all, variable_name),</span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a>          <span class="at">probs =</span> <span class="fu">seq</span>(.<span class="dv">1</span>, .<span class="dv">9</span>, .<span class="dv">1</span>)</span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Inf</span></span>
<span id="cb81-68"><a href="#cb81-68" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a>      labels_q <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"$</span><span class="sc">\\</span><span class="st">leq$ D1"</span>, <span class="st">"D1 to D2"</span>, <span class="st">"D2 to D3"</span>, <span class="st">"D3 to D4"</span>,</span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"D4 to D5"</span>, <span class="st">"D5 to D6"</span>, <span class="st">"D6 to D7"</span>, <span class="st">"D7 to D8"</span>, </span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"D8 to D9"</span>, <span class="st">"&gt; D9"</span></span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a>      ind_remove <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">duplicated</span>(breaks_q))</span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(ind_remove) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>        labels_q <span class="ot">&lt;-</span> labels_q[<span class="sc">-</span>ind_remove]</span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a>        breaks_q <span class="ot">&lt;-</span> breaks_q[<span class="sc">-</span>ind_remove]</span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a>      df_plot<span class="sc">$</span>quantile_variable <span class="ot">&lt;-</span> </span>
<span id="cb81-80"><a href="#cb81-80" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cut</span>(</span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(df_plot, <span class="st">"variable_value"</span>),</span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a>          <span class="at">labels =</span> labels_q,</span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> breaks_q</span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a>      df_plot <span class="ot">&lt;-</span> </span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a>        df_plot <span class="sc">|&gt;</span> </span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">quantile_revenu_num =</span> <span class="fu">as.numeric</span>(quantile_variable))</span>
<span id="cb81-89"><a href="#cb81-89" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb81-90"><a href="#cb81-90" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> </span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(</span>
<span id="cb81-92"><a href="#cb81-92" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> df_plot <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="dv">1</span>),,</span>
<span id="cb81-93"><a href="#cb81-93" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb81-94"><a href="#cb81-94" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> SHAP_value,</span>
<span id="cb81-95"><a href="#cb81-95" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> x,</span>
<span id="cb81-96"><a href="#cb81-96" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> quantile_revenu_num</span>
<span id="cb81-97"><a href="#cb81-97" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb81-98"><a href="#cb81-98" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb81-99"><a href="#cb81-99" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_sina</span>(<span class="at">alpha =</span> .<span class="dv">5</span>, <span class="at">size =</span> size_dots) <span class="sc">+</span></span>
<span id="cb81-100"><a href="#cb81-100" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb81-101"><a href="#cb81-101" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_color_gradient</span>(</span>
<span id="cb81-102"><a href="#cb81-102" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Variable value"</span>,</span>
<span id="cb81-103"><a href="#cb81-103" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">10</span>),</span>
<span id="cb81-104"><a href="#cb81-104" aria-hidden="true" tabindex="-1"></a>          <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">leq$ D1"</span>, <span class="st">"D3 to D4"</span>, <span class="st">"D6 to D7"</span>, <span class="st">"$&gt;$ D9"</span>),</span>
<span id="cb81-105"><a href="#cb81-105" aria-hidden="true" tabindex="-1"></a>          <span class="at">low =</span> <span class="st">"#0081BC"</span>, <span class="at">high =</span> <span class="st">"#EE324E"</span>,</span>
<span id="cb81-106"><a href="#cb81-106" aria-hidden="true" tabindex="-1"></a>          <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb81-107"><a href="#cb81-107" aria-hidden="true" tabindex="-1"></a>            <span class="at">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb81-108"><a href="#cb81-108" aria-hidden="true" tabindex="-1"></a>            <span class="at">barwidth =</span> bar_width,</span>
<span id="cb81-109"><a href="#cb81-109" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb81-110"><a href="#cb81-110" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.hjust =</span> .<span class="dv">5</span></span>
<span id="cb81-111"><a href="#cb81-111" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb81-112"><a href="#cb81-112" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb81-113"><a href="#cb81-113" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"SHAP value (impact on model output)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb81-114"><a href="#cb81-114" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(</span>
<span id="cb81-115"><a href="#cb81-115" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb81-116"><a href="#cb81-116" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"line"</span>),</span>
<span id="cb81-117"><a href="#cb81-117" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.width  =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">"line"</span>),</span>
<span id="cb81-118"><a href="#cb81-118" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb81-119"><a href="#cb81-119" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb81-120"><a href="#cb81-120" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb81-121"><a href="#cb81-121" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coord_flip</span>()</span>
<span id="cb81-122"><a href="#cb81-122" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb81-123"><a href="#cb81-123" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb81-124"><a href="#cb81-124" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Not using quantile</span></span>
<span id="cb81-125"><a href="#cb81-125" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> </span>
<span id="cb81-126"><a href="#cb81-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(</span>
<span id="cb81-127"><a href="#cb81-127" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> df_plot <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="dv">1</span>),</span>
<span id="cb81-128"><a href="#cb81-128" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb81-129"><a href="#cb81-129" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> x,</span>
<span id="cb81-130"><a href="#cb81-130" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> SHAP_value,</span>
<span id="cb81-131"><a href="#cb81-131" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> variable_value</span>
<span id="cb81-132"><a href="#cb81-132" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb81-133"><a href="#cb81-133" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb81-134"><a href="#cb81-134" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_sina</span>(<span class="at">alpha =</span> .<span class="dv">5</span>, <span class="at">size =</span> size_dots) <span class="sc">+</span></span>
<span id="cb81-135"><a href="#cb81-135" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb81-136"><a href="#cb81-136" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_color_gradient</span>(</span>
<span id="cb81-137"><a href="#cb81-137" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Variable value"</span>,</span>
<span id="cb81-138"><a href="#cb81-138" aria-hidden="true" tabindex="-1"></a>          <span class="at">low =</span> <span class="st">"#0081BC"</span>, <span class="at">high =</span> <span class="st">"#EE324E"</span>,</span>
<span id="cb81-139"><a href="#cb81-139" aria-hidden="true" tabindex="-1"></a>          <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb81-140"><a href="#cb81-140" aria-hidden="true" tabindex="-1"></a>            <span class="at">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb81-141"><a href="#cb81-141" aria-hidden="true" tabindex="-1"></a>            <span class="at">barwidth =</span> bar_width,</span>
<span id="cb81-142"><a href="#cb81-142" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb81-143"><a href="#cb81-143" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.hjust =</span> .<span class="dv">5</span>)</span>
<span id="cb81-144"><a href="#cb81-144" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb81-145"><a href="#cb81-145" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"SHAP value (impact on model output)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb81-146"><a href="#cb81-146" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(</span>
<span id="cb81-147"><a href="#cb81-147" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb81-148"><a href="#cb81-148" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"line"</span>),</span>
<span id="cb81-149"><a href="#cb81-149" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.width  =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">"line"</span>),</span>
<span id="cb81-150"><a href="#cb81-150" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb81-151"><a href="#cb81-151" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb81-152"><a href="#cb81-152" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb81-153"><a href="#cb81-153" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coord_flip</span>()</span>
<span id="cb81-154"><a href="#cb81-154" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb81-155"><a href="#cb81-155" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-156"><a href="#cb81-156" aria-hidden="true" tabindex="-1"></a>  p <span class="sc">+</span> <span class="fu">theme</span>(</span>
<span id="cb81-157"><a href="#cb81-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb81-158"><a href="#cb81-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.3</span>), <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb81-159"><a href="#cb81-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(.<span class="dv">8</span>)),</span>
<span id="cb81-160"><a href="#cb81-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(.<span class="dv">8</span>))</span>
<span id="cb81-161"><a href="#cb81-161" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb81-162"><a href="#cb81-162" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" role="tab" aria-controls="tabset-9-1" aria-selected="true">Age</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-2" role="tab" aria-controls="tabset-9-2" aria-selected="false">Gender = Male</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-3" role="tab" aria-controls="tabset-9-3" aria-selected="false">Net Income per Cons. Unit</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-4" role="tab" aria-controls="tabset-9-4" aria-selected="false">Waiver Dental Care = No</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-5" role="tab" aria-controls="tabset-9-5" aria-selected="false">Neck Pain = Yes</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-6" role="tab" aria-controls="tabset-9-6" aria-selected="false">Frequency Meeting with People in Organizations = Never</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-7" role="tab" aria-controls="tabset-9-7" aria-selected="false">Deduct. Pharmacy</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-8" role="tab" aria-controls="tabset-9-8" aria-selected="false">Low Back Pain = Yes</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-9" role="tab" aria-controls="tabset-9-9" aria-selected="false">Have to Hurry to Do Job = Sometimes</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-10-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-10" role="tab" aria-controls="tabset-9-10" aria-selected="false">Allergy = Yes</a></li></ul>
<div class="tab-content">
<div id="tabset-9-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-9-1-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Age</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-127-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-2-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Gender = Male</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-129-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-3-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Net Income per Cons. Unit</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-131-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-4-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Waiver Dental Care = No</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-133-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-5-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Neck Pain = Yes</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-135-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-6-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Frequency Meeting with People in Organizations = Never</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-137-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-7-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Deduct. Pharmacy</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-139-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-8-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Low Back Pain = Yes</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-141-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-9-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Have to Hurry to Do Job = Sometimes</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-143-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-10" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-10-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Allergy = Yes</figcaption>
<p><img src="robustness-shap-results-sah_files/figure-html/unnamed-chunk-145-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="clustering" class="level2" data-number="20.5">
<h2 data-number="20.5" class="anchored" data-anchor-id="clustering"><span class="header-section-number">20.5</span> Clustering</h2>
<p>It may be possible to group individuals in the dataset depending the profile of the shap values. Let us perform a hierarchical clustering to group the individuals depending on their Shapley values. We will only keep a few variables to represent each individual, and will focus only on people classified as imaginary healthy patients. First, let us compute the aberage Shapley value for each variable, among the predicted imaginary healthy patients.</p>
<section id="note" class="level3 {callout-note}" data-number="20.5.1">
<h3 data-number="20.5.1" class="anchored" data-anchor-id="note"><span class="header-section-number">20.5.1</span> Note</h3>
<p>We only focus on the SHAP values computed based on the predictions made with XGBoost in this part.</p>
</section>
<p>Recall we put in a tibble (<code>order_variables_shap_xgb</code>) the average absolute SHAP values (column <code>value</code>) and the average SHAP values (column <code>mean</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>order_variables_shap_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 188 × 3
   name                     value     mean
   &lt;chr&gt;                    &lt;dbl&gt;    &lt;dbl&gt;
 1 PERSONNE_age            0.152  -0.0146 
 2 PERSONNE_sexeMale       0.129  -0.00171
 3 MENAGE_revucinsee       0.119  -0.00860
 4 OPINION1_renonc_dentNo  0.102  -0.0146 
 5 PERSONNE_pb_cervicalYes 0.0863 -0.00842
 6 QES_tpsassoNever        0.0810 -0.00288
 7 SOINS_pf_frpha          0.0792 -0.00322
 8 PERSONNE_pb_lombalgiYes 0.0751 -0.00566
 9 QST_ct_depechSometimes  0.0744 -0.00724
10 PERSONNE_pb_allergiYes  0.0697 -0.00710
# ℹ 178 more rows</code></pre>
</div>
</div>
<p>We can display the average of the absolute SHAP values on a plot. A vertical red line is added at the average of the average of absolute Shapley values. Red dots indicate variables with negative average Shapley values, green dots indicate positive average values, and gray dots indicate zero average values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> order_variables_shap_xgb <span class="sc">|&gt;</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(variable_names_categ, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label), label_categ, label)) <span class="sc">|&gt;</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">mean_abs_shap_value =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">sign =</span> <span class="fu">sign</span>(mean),</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">sign =</span> <span class="fu">factor</span>(sign, <span class="at">levels =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-"</span>, <span class="st">"0"</span>, <span class="st">"+"</span>))</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">fct_reorder</span>(label, <span class="fu">desc</span>(mean_abs_shap_value)),</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> mean_abs_shap_value</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">colour =</span> sign)) <span class="sc">+</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">xintercept =</span> <span class="fu">mean</span>(order_variables_shap_xgb<span class="sc">$</span>value), <span class="at">colour =</span> <span class="st">"red"</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Feature impact"</span>,</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"-"</span> <span class="ot">=</span> <span class="st">"#EE324E"</span>, <span class="st">"+"</span> <span class="ot">=</span> <span class="st">"#009D57"</span>, <span class="st">"0"</span> <span class="ot">=</span> <span class="st">"gray"</span>),</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-"</span> <span class="ot">=</span> <span class="st">"Negative"</span>, <span class="st">"+"</span> <span class="ot">=</span> <span class="st">"Positive"</span>)</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mean(|Shap value|)"</span>, <span class="at">y =</span> <span class="st">"Variable"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mean-shap-val-variables" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-mean-shap-val-variables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.9: Mean absolute SHAP values for each variable
</figcaption>
<div aria-describedby="fig-mean-shap-val-variables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-mean-shap-val-variables-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
<p>Let us create a table in which we only keep the individuals predicted as imaginary healthy patients:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>df_clustering_Not_D_and_inf_Q1 <span class="ot">&lt;-</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  treeshap_xgb<span class="sc">$</span>shaps <span class="sc">|&gt;</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_row =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted =</span> pred_val_all_xgb) <span class="sc">|&gt;</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(predicted <span class="sc">&gt;</span> .<span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>predicted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us only keep the 14 variables with the highest mean absolute Shapley values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>nb_top <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>variables_to_keep_cluster <span class="ot">&lt;-</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  order_variables_shap_xgb <span class="sc">|&gt;</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> nb_top) <span class="sc">|&gt;</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(<span class="st">"name"</span>)</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>variables_to_keep_cluster</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "PERSONNE_age"                  "PERSONNE_sexeMale"            
 [3] "MENAGE_revucinsee"             "OPINION1_renonc_dentNo"       
 [5] "PERSONNE_pb_cervicalYes"       "QES_tpsassoNever"             
 [7] "SOINS_pf_frpha"                "PERSONNE_pb_lombalgiYes"      
 [9] "QST_ct_depechSometimes"        "PERSONNE_pb_allergiYes"       
[11] "SOINS_remomn"                  "OPINION1_renonc_consNo answer"
[13] "SOINS_seac_omn"                "PERSONNE_coupleYes"           </code></pre>
</div>
</div>
<p>We can visualize which variables were kept:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> order_variables_shap_xgb <span class="sc">|&gt;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(variable_names_categ, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label), label_categ, label)) <span class="sc">|&gt;</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">mean_abs_shap_value =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">in_top_kept =</span> name <span class="sc">%in%</span> variables_to_keep_cluster</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">fct_reorder</span>(label, <span class="fu">desc</span>(mean_abs_shap_value)),</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> mean_abs_shap_value</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">colour =</span> in_top_kept)) <span class="sc">+</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">xintercept =</span> <span class="fu">mean</span>(order_variables_shap_xgb<span class="sc">$</span>value), <span class="at">colour =</span> <span class="st">"red"</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Variable kept for clustering"</span>,</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"gray"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#009D57"</span>),</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"Discarded"</span>, <span class="st">"+"</span> <span class="ot">=</span> <span class="st">"Kept"</span>)</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mean(|Shap value|)"</span>, <span class="at">y =</span> <span class="st">"Variable"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mean-shap-val-variables-kept" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-mean-shap-val-variables-kept-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.10: Variables kept for the clustering and their averable absolute Shapley value.
</figcaption>
<div aria-describedby="fig-mean-shap-val-variables-kept-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-mean-shap-val-variables-kept-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
<p>We need to select a number of clusters K. Instead of arbitrarily pick a value, we vary the number of clusters and look at the silhouette information for each value K.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>sil_val <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>dist_m <span class="ot">&lt;-</span> <span class="fu">dist</span>(</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    df_clustering_Not_D_and_inf_Q1 <span class="sc">|&gt;</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">!!!</span><span class="fu">syms</span>(variables_to_keep_cluster))</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>hierarchical_clust <span class="ot">&lt;-</span> <span class="fu">hclust</span>(dist_m, <span class="at">method =</span> <span class="st">"ward.D"</span>)</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (K <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">15</span>) {</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>  clusters_k <span class="ot">&lt;-</span> <span class="fu">cutree</span>(hierarchical_clust, K)</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>  sil <span class="ot">&lt;-</span> cluster<span class="sc">::</span><span class="fu">silhouette</span>(clusters_k, dist_m)</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>  sil_val <span class="ot">&lt;-</span> <span class="fu">c</span>(sil_val, <span class="fu">mean</span>(sil[, <span class="dv">3</span>]))</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>p_silhouette <span class="ot">&lt;-</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">K =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y =</span> sil_val), <span class="fu">aes</span>(<span class="at">x =</span> K, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"K"</span>, <span class="at">y =</span> <span class="st">"Silhouette score"</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>p_silhouette</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-silhouette-scores" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-silhouette-scores-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.11: Silhouette scores
</figcaption>
<div aria-describedby="fig-silhouette-scores-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-silhouette-scores-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>We hence pick 4 as the number of desired clusters, and then assign the observation their cluster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>clusters_km_Not_D_and_inf_Q <span class="ot">&lt;-</span> hierarchical_clust</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>df_clustering_Not_D_and_inf_Q1<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">cutree</span>(clusters_km_Not_D_and_inf_Q, K)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We create a table to plot the Shap values of these individuals, and order the observations according to their distance from each other.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> df_clustering_Not_D_and_inf_Q1[clusters_km_Not_D_and_inf_Q<span class="sc">$</span>order, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For variables that are not in the top, we create an “Other” category.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>id_row) <span class="sc">|&gt;</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(cluster, x), <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">ifelse</span>(</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">%in%</span> variables_to_keep_cluster,</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">yes =</span> variable,</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">no =</span> <span class="st">"Other"</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster, x, variable) <span class="sc">|&gt;</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">mean</span>(value), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>    variable_names <span class="sc">|&gt;</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(variable_names_categ <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, <span class="at">label =</span> label_categ)) <span class="sc">|&gt;</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">variable =</span> <span class="st">"Other"</span>, <span class="at">label =</span> <span class="st">"Other"</span>, <span class="at">type =</span> <span class="cn">NA</span>)),</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"variable"</span> <span class="ot">=</span> <span class="st">"variable"</span>)</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The order of the variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>labels_order <span class="ot">&lt;-</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">variable =</span> variables_to_keep_cluster) <span class="sc">|&gt;</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variable_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"variable"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variable_names_categ, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"variable"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label), label_categ, label)) <span class="sc">|&gt;</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(label)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>labels_order <span class="ot">&lt;-</span> <span class="fu">c</span>(labels_order, <span class="st">"Other"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We apply this order to the variables in the data plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="sc">|&gt;</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">factor</span>(label, <span class="at">levels =</span> labels_order))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can plot the graph to visualize the average the contribution of each variable of the top within each cluster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>nb_vars <span class="ot">&lt;-</span> df_plot<span class="sc">$</span>variable <span class="sc">|&gt;</span> <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">length</span>()</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>x_lines <span class="ot">&lt;-</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="sc">|&gt;</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">|&gt;</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">x_max =</span> <span class="fu">max</span>(x)) <span class="sc">|&gt;</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(x_max) <span class="sc">|&gt;</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>()</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>x_lines <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, x_lines)</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="co"># colours &lt;- Polychrome::createPalette(nb_top,  c("#ff0000", "#00ff00", "#0000ff"))</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="co"># names(colours) &lt;- NULL</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>plot_clusters <span class="ot">&lt;-</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> df_plot) <span class="sc">+</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> x_lines) <span class="sc">+</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> value, <span class="at">fill =</span> label), <span class="at">width =</span><span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>, <span class="at">values =</span> <span class="fu">c</span>(RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(nb_vars<span class="dv">-1</span>, <span class="st">'Paired'</span>), <span class="st">"green"</span>, <span class="st">"black"</span>, <span class="st">"gray"</span>)</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_fill_manual("", values = c(colours, "gray")) +</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Individuals"</span>, <span class="at">y =</span> <span class="st">"Output value"</span>) <span class="sc">+</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># theme_paper() +</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>plot_clusters <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">ncol =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-shap-val-clusters-all-indiv" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-shap-val-clusters-all-indiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.12: Decomposition of the Effect of the Most Important Variables on the Probability of Being Predicted as an Imaginary Healthy Patient for Individuals Predicted as Such. All individuals.
</figcaption>
<div aria-describedby="fig-shap-val-clusters-all-indiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-shap-val-clusters-all-indiv-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
<p>With aggregated mean SHAP values at the cluster level:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>df_plot_cluster <span class="ot">&lt;-</span> </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="sc">|&gt;</span> </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster, variable, label) <span class="sc">|&gt;</span> </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">value =</span> <span class="fu">mean</span>(value)) <span class="sc">|&gt;</span> </span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">factor</span>(cluster, <span class="at">levels =</span> <span class="fu">unique</span>(df_plot<span class="sc">$</span>cluster)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'cluster', 'variable'. You can override
using the `.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>plot_clusters_2 <span class="ot">&lt;-</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_plot_cluster <span class="sc">|&gt;</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">cluster =</span> <span class="fu">factor</span>(</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>          cluster,</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">levels =</span> <span class="fu">levels</span>(df_plot_cluster<span class="sc">$</span>cluster),</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">labels =</span> <span class="fu">seq_len</span>(<span class="fu">length</span>(<span class="fu">levels</span>(df_plot_cluster<span class="sc">$</span>cluster)))</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> cluster, <span class="at">fill =</span> label, <span class="at">y =</span> value)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">position =</span> <span class="st">"stack"</span>, <span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Cluster"</span>,<span class="at">y =</span> <span class="st">"Output value"</span>) <span class="sc">+</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_fill_manual("", values = c(colours, "gray")) +</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>, </span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(nb_vars<span class="dv">-1</span>, <span class="st">'Paired'</span>), <span class="st">"green"</span>, <span class="st">"black"</span>, <span class="st">"gray"</span>)</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in RColorBrewer::brewer.pal(nb_vars - 1, "Paired"): n too large, allowed maximum for palette Paired is 12
Returning the palette you asked for with that many colors</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>plot_clusters_2 <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">ncol =</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-shap-val-clusters-average" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-shap-val-clusters-average-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.13: Decomposition of the Effect of the Most Important Variables on the Probability of Being Predicted as an Imaginary Healthy Patient for Individuals Predicted as Such. Average per Cluster.
</figcaption>
<div aria-describedby="fig-shap-val-clusters-average-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="robustness-shap-results-sah_files/figure-html/fig-shap-val-clusters-average-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
<section id="descriptive-statistics-of-the-clusters" class="level3" data-number="20.5.2">
<h3 data-number="20.5.2" class="anchored" data-anchor-id="descriptive-statistics-of-the-clusters"><span class="header-section-number">20.5.2</span> Descriptive Statistics of the Clusters</h3>
<p>Let us now get some descriptive statistics at the cluster level, for each of these variables. We need to get the values of the variables for the individuals predicted as imaginary healthy patients.</p>
<p>For categorical variables, we would like to get the most frequent value, in each cluster. For numerical variables, we would like to get the average and standard deviation. Let us isolate these two types of variables.</p>
<p>The categorical variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>top_name_categ <span class="ot">&lt;-</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  variable_names_categ <span class="sc">|&gt;</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> top_n_variables_xgb) <span class="sc">|&gt;</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(<span class="st">"variable_raw"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The numerical variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>top_name_num <span class="ot">&lt;-</span> top_n_variables_xgb[<span class="sc">!</span>top_n_variables_xgb <span class="sc">%in%</span> variable_names_categ<span class="sc">$</span>variable]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us create a dataset with the characteristics and the cluster in which the individuals belong:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>df_stat_des <span class="ot">&lt;-</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  df_all_xgb <span class="sc">|&gt;</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_row =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add cluster</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    df_clustering_Not_D_and_inf_Q1 <span class="sc">|&gt;</span> <span class="fu">select</span>(id_row, cluster),</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"id_row"</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We define a function, <code class="sourceCode r"><span class="fu">get_stats</span>()</code> which computes the desired statistics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>get_stats <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Desc. Stat on numerical variables</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  df_num <span class="ot">&lt;-</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">|&gt;</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">!!</span>top_name_num) <span class="sc">|&gt;</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value), <span class="at">sd =</span> <span class="fu">sd</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">str_c</span>(<span class="fu">round</span>(mean, <span class="dv">2</span>), <span class="st">" ("</span>, <span class="fu">round</span>(sd, <span class="dv">2</span>),<span class="st">")"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(name, value)</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  df_categ <span class="ot">&lt;-</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">|&gt;</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">!!</span>top_name_categ) <span class="sc">|&gt;</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(value) <span class="sc">|&gt;</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pct =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span>n <span class="sc">/</span> <span class="fu">sum</span>(n), <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_max</span>(<span class="at">order_by =</span> pct, <span class="at">n =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">str_c</span>(value, <span class="st">' ('</span>, pct, <span class="st">"%)"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(name, value)</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>  df_num <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>(df_categ)</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will compute the statistics on the following datasets:</p>
<ul>
<li>whole dataset</li>
<li>sample of individuals predicted as imaginary healthy patients</li>
<li>each of the clusters (i.e., sub sample of the sample of individuals predicted as imaginary healthy patients).</li>
</ul>
<p>On the whole dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>stat_des_whole <span class="ot">&lt;-</span> <span class="fu">get_stats</span>(df_stat_des) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Whole sample"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On the dataset of individuals predicted as imaginary healthy patients by the classifier:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>stat_des_imaginary <span class="ot">&lt;-</span> df_stat_des <span class="sc">|&gt;</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id_row <span class="sc">%in%</span> df_clustering_Not_D_and_inf_Q1<span class="sc">$</span>id_row) <span class="sc">|&gt;</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stats</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Imaginary healthy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And on each of the clusters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>df_stat_des_clusters <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_clust <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  df_stat_des_clusters <span class="ot">&lt;-</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    df_stat_des_clusters <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>(</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>      df_stat_des <span class="sc">|&gt;</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(cluster <span class="sc">==</span> <span class="sc">!!</span>i_clust) <span class="sc">|&gt;</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_stats</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">as.character</span>(i_clust))</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also compare the clusters by computing the p-values of an ANOVA for quantitative variables, and of a chi-squared test for qualitative variables.</p>
<p>For quantitative variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>p_values_categ <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name <span class="cf">in</span> top_name_categ) {</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  values <span class="ot">&lt;-</span> df_stat_des <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>name)</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># confusion matrix</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  tab <span class="ot">&lt;-</span> <span class="fu">table</span>(df_stat_des<span class="sc">$</span>cluster, values)</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># chi-squared test</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  chi2 <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(tab, <span class="at">correct =</span> T)</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># p-value</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  pvalue <span class="ot">&lt;-</span> chi2<span class="sc">$</span>p.value</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  p_values_categ <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>    p_values_categ,</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">name =</span> name, <span class="at">pvalue =</span> pvalue)</span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For numerical variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>p_values_num <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name <span class="cf">in</span> top_name_num) {</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># anova test</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  values <span class="ot">&lt;-</span> df_stat_des <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>name)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  anova <span class="ot">&lt;-</span> <span class="fu">anova</span>(<span class="fu">aov</span>(<span class="fu">as.numeric</span>(values) <span class="sc">~</span> df_stat_des<span class="sc">$</span>cluster))</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># p-value</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  pvalue <span class="ot">&lt;-</span> anova<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>[<span class="dv">1</span>]</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>  p_values_num <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    p_values_num,</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">name =</span> name, <span class="at">pvalue =</span> pvalue)</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We merge the p-values in a single object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>tb_p_values <span class="ot">&lt;-</span> p_values_categ <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>(p_values_num)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To build a prettier table, let us build a tibble with the labels of the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>table_ref <span class="ot">&lt;-</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">variable =</span> top_n_variables_xgb) <span class="sc">|&gt;</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variable_names_categ, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"variable"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(variable_raw), variable, variable_raw)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    variable_names, <span class="at">by =</span> <span class="st">"variable"</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us merge the three tables with the descriptive statistics and add the p-values of the clusters comparisons.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>tb_desc_stats_clusters <span class="ot">&lt;-</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  df_stat_des_clusters <span class="sc">|&gt;</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(stat_des_whole) <span class="sc">|&gt;</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(stat_des_imaginary) <span class="sc">|&gt;</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">factor</span>(type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>K, <span class="st">"Imaginary healthy"</span>, <span class="st">"Whole sample"</span>))</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> type, <span class="at">values_from =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>    table_ref <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, label),</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"variable"</span>)</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">unique</span>(tb_p_values), <span class="at">by =</span> <span class="st">"name"</span>) <span class="sc">|&gt;</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(label, <span class="at">.before =</span> name) <span class="sc">|&gt;</span></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">|&gt;</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">factor</span>(label, <span class="at">levels =</span> <span class="fu">unique</span>(table_ref<span class="sc">$</span>label))) <span class="sc">|&gt;</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>tb_desc_stats_clusters <span class="sc">|&gt;</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>pvalue) <span class="sc">|&gt;</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">p_value =</span> <span class="fu">format.pval</span>(tb_desc_stats_clusters<span class="sc">$</span>pvalue, <span class="dv">2</span>)) <span class="sc">|&gt;</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> F, <span class="at">html_font =</span> <span class="st">"Cambria"</span>) <span class="sc">|&gt;</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>)</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-average-indiv-cluster" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-average-indiv-cluster-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;20.2: Average individual in each cluster and in the sample
</figcaption>
<div aria-describedby="tbl-average-indiv-cluster-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="table-responsive">
<table class="lightable-classic table table-striped table-hover table-condensed do-not-create-environment cell caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">label</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">1</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">2</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">3</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">4</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Whole sample</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Imaginary healthy</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">p_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Age</td>
<td style="text-align: left;">51.98 (16.51)</td>
<td style="text-align: left;">40.84 (10.32)</td>
<td style="text-align: left;">37.05 (12.29)</td>
<td style="text-align: left;">71.38 (9.88)</td>
<td style="text-align: left;">47.57 (18.17)</td>
<td style="text-align: left;">47.48 (17)</td>
<td style="text-align: left;">&lt; 2e-16</td>
</tr>
<tr class="even">
<td style="text-align: left;">Gender</td>
<td style="text-align: left;">Female (98.9%)</td>
<td style="text-align: left;">Female (66.2%)</td>
<td style="text-align: left;">Female (63.6%)</td>
<td style="text-align: left;">Female (61.3%)</td>
<td style="text-align: left;">Female (52.9%)</td>
<td style="text-align: left;">Female (71.6%)</td>
<td style="text-align: left;">&lt; 2e-16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Net Income per Cons. Unit</td>
<td style="text-align: left;">1501.28 (707.97)</td>
<td style="text-align: left;">1577.88 (745.3)</td>
<td style="text-align: left;">590.34 (160.11)</td>
<td style="text-align: left;">1357.57 (735.06)</td>
<td style="text-align: left;">1620.05 (1004.37)</td>
<td style="text-align: left;">1322.78 (759.48)</td>
<td style="text-align: left;">&lt; 2e-16</td>
</tr>
<tr class="even">
<td style="text-align: left;">Waiver Dental Care</td>
<td style="text-align: left;">No (71.2%)</td>
<td style="text-align: left;">No (62.3%)</td>
<td style="text-align: left;">No (47.4%)</td>
<td style="text-align: left;">No (59.9%)</td>
<td style="text-align: left;">No (66.3%)</td>
<td style="text-align: left;">No (60.7%)</td>
<td style="text-align: left;">&lt; 2e-16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Neck Pain</td>
<td style="text-align: left;">Yes (100%)</td>
<td style="text-align: left;">No (88.1%)</td>
<td style="text-align: left;">No (94.8%)</td>
<td style="text-align: left;">No (85.7%)</td>
<td style="text-align: left;">No (82.2%)</td>
<td style="text-align: left;">No (70.9%)</td>
<td style="text-align: left;">&lt; 2e-16</td>
</tr>
<tr class="even">
<td style="text-align: left;">Frequency Meeting with People in Organizations</td>
<td style="text-align: left;">Never (48.5%)</td>
<td style="text-align: left;">Never (63.2%)</td>
<td style="text-align: left;">Never (66.7%)</td>
<td style="text-align: left;">Never (54.9%)</td>
<td style="text-align: left;">Never (50.4%)</td>
<td style="text-align: left;">Never (59.5%)</td>
<td style="text-align: left;">5.1e-13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Deduct. Pharmacy</td>
<td style="text-align: left;">19.73 (16.58)</td>
<td style="text-align: left;">15.44 (13)</td>
<td style="text-align: left;">4.55 (9.49)</td>
<td style="text-align: left;">34.19 (14.28)</td>
<td style="text-align: left;">12.55 (14.7)</td>
<td style="text-align: left;">17.23 (16.25)</td>
<td style="text-align: left;">2.3e-14</td>
</tr>
<tr class="even">
<td style="text-align: left;">Low Back Pain</td>
<td style="text-align: left;">Yes (50.9%)</td>
<td style="text-align: left;">No (71.4%)</td>
<td style="text-align: left;">No (82.5%)</td>
<td style="text-align: left;">No (56.5%)</td>
<td style="text-align: left;">No (77.5%)</td>
<td style="text-align: left;">No (66.6%)</td>
<td style="text-align: left;">&lt; 2e-16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Have to Hurry to Do Job</td>
<td style="text-align: left;">No answer (50.9%)</td>
<td style="text-align: left;">Often (37%)</td>
<td style="text-align: left;">No answer (79.9%)</td>
<td style="text-align: left;">No answer (93.4%)</td>
<td style="text-align: left;">No answer (49.7%)</td>
<td style="text-align: left;">No answer (51.8%)</td>
<td style="text-align: left;">&lt; 2e-16</td>
</tr>
<tr class="even">
<td style="text-align: left;">Allergy</td>
<td style="text-align: left;">No (67.8%)</td>
<td style="text-align: left;">No (70.9%)</td>
<td style="text-align: left;">No (81.4%)</td>
<td style="text-align: left;">No (80.6%)</td>
<td style="text-align: left;">No (81.9%)</td>
<td style="text-align: left;">No (74%)</td>
<td style="text-align: left;">8.6e-12</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</figure>
</div>
</div>
<p>Number of observation per cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(df_clustering_Not_D_and_inf_Q1<span class="sc">$</span>cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  1   2   3   4 
466 949 462 377 </code></pre>
</div>
</div>
<p>Number of observation in the whole sample:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(df_stat_des)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5380</code></pre>
</div>
</div>
<p>Number of individuals predicted <em>imaginary healthy</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(df_clustering_Not_D_and_inf_Q1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2254</code></pre>
</div>
</div>
<p>Remaining obs (sanity check):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>df_stat_des <span class="sc">|&gt;</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>id_row <span class="sc">%in%</span> df_clustering_Not_D_and_inf_Q1<span class="sc">$</span>id_row) <span class="sc">|&gt;</span> </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3126</code></pre>
</div>
</div>
<p>Predicted class by XGB:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Healthy</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>pred_class_xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  grid_search_xgb, <span class="at">newdata =</span> df_all_xgb</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Overview of predictions in each clusters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>df_stat_des <span class="sc">|&gt;</span> </span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted_val =</span> pred_val_all_xgb) <span class="sc">|&gt;</span> </span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_class =</span> pred_class_xgb,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">correctly_pred =</span> pred_class <span class="sc">==</span> status</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only predicted as imaginary healthy</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cluster)) <span class="sc">|&gt;</span> </span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">|&gt;</span> </span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracy =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">mean</span>(correctly_pred), <span class="dv">1</span>),</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">no_im_healthy =</span> <span class="fu">sum</span>(status <span class="sc">==</span> <span class="st">"Not_D_and_inf_Q1"</span>),</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_im_healthy =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>no_im_healthy <span class="sc">/</span> n, <span class="dv">1</span>)</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  cluster     n accuracy no_im_healthy pct_im_healthy
    &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;         &lt;int&gt;          &lt;dbl&gt;
1       1   466     51.9           242           51.9
2       2   949     46.6           442           46.6
3       3   462     47             217           47  
4       4   377     40.8           154           40.8</code></pre>
</div>
</div>
<p>Overall accuracy:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>df_stat_des <span class="sc">|&gt;</span> </span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted_val =</span> pred_val_all_xgb) <span class="sc">|&gt;</span> </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_class =</span> <span class="fu">ifelse</span>(</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>      predicted_val <span class="sc">&gt;</span> .<span class="dv">5</span>, </span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">yes =</span> <span class="st">"Not_D_and_inf_Q1"</span>, <span class="st">"Not_D_and_sup_Q1"</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">correctly_pred =</span> pred_class <span class="sc">==</span> status</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracy =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">mean</span>(correctly_pred),<span class="dv">1</span>),</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">no_im_healthy =</span> <span class="fu">sum</span>(status <span class="sc">==</span> <span class="st">"Not_D_and_inf_Q1"</span>),</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_im_healthy =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>no_im_healthy <span class="sc">/</span> n, <span class="dv">1</span>)</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
      n accuracy no_im_healthy pct_im_healthy
  &lt;int&gt;    &lt;dbl&gt;         &lt;int&gt;          &lt;dbl&gt;
1  5380     67.7          1592           29.6</code></pre>
</div>
</div>
<p>Percentage of individuals correctly predicted <code class="sourceCode r">Not_D_and_inf_Q1</code>, i.e., <em>imaginary healthy</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>df_stat_des <span class="sc">|&gt;</span> </span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted_val =</span> pred_val_all_xgb) <span class="sc">|&gt;</span> </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_class =</span> <span class="fu">ifelse</span>(</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>      predicted_val <span class="sc">&gt;</span> .<span class="dv">5</span>, </span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">yes =</span> <span class="st">"Not_D_and_inf_Q1"</span>, <span class="st">"Not_D_and_sup_Q1"</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">correctly_pred =</span> pred_class <span class="sc">==</span> status</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pred_class <span class="sc">==</span> <span class="st">"Not_D_and_inf_Q1"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracy =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">mean</span>(correctly_pred),<span class="dv">1</span>),</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">no_im_healthy =</span> <span class="fu">sum</span>(status <span class="sc">==</span> <span class="st">"Not_D_and_inf_Q1"</span>),</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_im_healthy =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>no_im_healthy <span class="sc">/</span> n, <span class="dv">1</span>)</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
      n accuracy no_im_healthy pct_im_healthy
  &lt;int&gt;    &lt;dbl&gt;         &lt;int&gt;          &lt;dbl&gt;
1  2254     46.8          1055           46.8</code></pre>
</div>
</div>
<p>Percentage of individuals correctly predicted <code class="sourceCode r">Not_D_and_sup_Q1</code>, i.e., <em>healthy</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># healthy</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>df_stat_des <span class="sc">|&gt;</span> </span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted_val =</span> pred_val_all_xgb) <span class="sc">|&gt;</span> </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_class =</span> <span class="fu">ifelse</span>(</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>      predicted_val <span class="sc">&gt;</span> .<span class="dv">5</span>, </span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">yes =</span> <span class="st">"Not_D_and_inf_Q1"</span>, <span class="st">"Not_D_and_sup_Q1"</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">correctly_pred =</span> pred_class <span class="sc">==</span> status</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pred_class <span class="sc">==</span> <span class="st">"Not_D_and_sup_Q1"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">accuracy =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">mean</span>(correctly_pred),<span class="dv">1</span>),</span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">no_im_healthy =</span> <span class="fu">sum</span>(status <span class="sc">==</span> <span class="st">"Not_D_and_inf_Q1"</span>),</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_im_healthy =</span> <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>no_im_healthy <span class="sc">/</span> n, <span class="dv">1</span>)</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
      n accuracy no_im_healthy pct_im_healthy
  &lt;int&gt;    &lt;dbl&gt;         &lt;int&gt;          &lt;dbl&gt;
1  3126     82.8           537           17.2</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./robustness-shap-estimations-sah.html" class="pagination-link" aria-label="Estimations">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Estimations</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>